From 1c5f2c9fdfca5cbd8a5d9a18fb4830dd5613bf50 Mon Sep 17 00:00:00 2001
From: Jon Daniel <joneqdaniel@gmail.com>
Date: Thu, 10 Apr 2025 00:18:47 +0200
Subject: [PATCH 1/2] do not require backtrace make it an option

---
 config.d/backtrace.m4                | 11 +++++++++++
 configure.ac                         |  3 +--
 include/QF/backtrace.h               | 10 ++++++++++
 libs/util/backtrace.c                | 10 ++--------
 libs/video/renderer/vulkan/staging.c |  2 ++
 nq/source/host.c                     |  2 ++
 ruamoko/qwaq/builtins/graphics.c     |  5 ++++-
 7 files changed, 32 insertions(+), 11 deletions(-)

diff --git a/config.d/backtrace.m4 b/config.d/backtrace.m4
index 5dd2b0a080..70f44938d0 100644
--- a/config.d/backtrace.m4
+++ b/config.d/backtrace.m4
@@ -1,5 +1,16 @@
+AC_ARG_ENABLE(backtrace,
+	AS_HELP_STRING(
+		[--disable-backtrace],
+		[disable use of libbacktrace]
+	)
+)
+HAVE_BACKTRACE=no
+if test "x$enable_backtrace" = "xyes"; then
 AC_CHECK_LIB([backtrace], [backtrace_create_state],
 	[HAVE_BACKTRACE=yes
 	 BACKTRACE_LIBS=-lbacktrace],
 	[HAVE_BACKTRACE=no])
 AC_SUBST(BACKTRACE_LIBS)
+fi
+AM_CONDITIONAL(HAVE_BACKTRACE, test "x$HAVE_BACKTRACE" = "xyes")
+
diff --git a/configure.ac b/configure.ac
index b69fdbda66..135bd61adf 100644
--- a/configure.ac
+++ b/configure.ac
@@ -140,6 +140,7 @@ m4_include(config.d/paths.m4)
 
 m4_include(config.d/build_control.m4)
 m4_include(config.d/qfcc.m4)
+
 m4_include(config.d/tracy.m4)
 m4_include(config.d/backtrace.m4)
 
@@ -178,7 +179,6 @@ case "${host}" in
 			[fontconfig, HAVE_FONTCONFIG],
 			[freetype, HAVE_FREETYPE],
 			[harfbuzz, HAVE_HARFBUZZ],
-			[backtrace, HAVE_BACKTRACE],
 		])
 	;;
 	*linux*)
@@ -203,7 +203,6 @@ case "${host}" in
 			[libfontconfig-dev, HAVE_FONTCONFIG],
 			[libfreetype-dev, HAVE_FREETYPE],
 			[libharfbuzz-dev, HAVE_HARFBUZZ],
-			[backtrace, HAVE_BACKTRACE],
 		])
 	;;
 esac
diff --git a/include/QF/backtrace.h b/include/QF/backtrace.h
index 29d209ea05..e69e016753 100644
--- a/include/QF/backtrace.h
+++ b/include/QF/backtrace.h
@@ -30,11 +30,21 @@
 #ifndef __QF_backtrace_h
 #define __QF_backtrace_h
 
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#ifdef HAVE_BACKTRACE
+
 #include <stdint.h>
+#include <inttypes.h>
+#include <string.h>
+#include <backtrace.h>
 
 typedef struct dstring_s dstring_t;
 
 void BT_Init (const char *filename);
 void BT_pcInfo (dstring_t *str, uintptr_t pc);
 void BT_backtrace (dstring_t *str, int skip);
+#endif
 
 #endif// __QF_backtrace_h
diff --git a/libs/util/backtrace.c b/libs/util/backtrace.c
index 7a36fe761e..785e0a75ae 100644
--- a/libs/util/backtrace.c
+++ b/libs/util/backtrace.c
@@ -27,15 +27,8 @@
 		Boston, MA  02111-1307, USA
 
 */
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include <inttypes.h>
-#include <string.h>
-#include <backtrace.h>
-
 #include "QF/backtrace.h"
+#ifdef HAVE_BACKTRACE
 #include "QF/dstring.h"
 #include "QF/sys.h"
 
@@ -74,3 +67,4 @@ BT_pcInfo (dstring_t *str, uintptr_t pc)
 		dasprintf (str, "(%"PRIxPTR")", pc);
 	}
 }
+#endif
diff --git a/libs/video/renderer/vulkan/staging.c b/libs/video/renderer/vulkan/staging.c
index 483f2a03e9..985368a6ab 100644
--- a/libs/video/renderer/vulkan/staging.c
+++ b/libs/video/renderer/vulkan/staging.c
@@ -258,7 +258,9 @@ QFV_PacketAcquire (qfv_stagebuf_t *stage)
 		auto end = Sys_LongTime ();
 		if (end - start > 500) {
 			dstring_t  *str = dstring_newstr ();
+#ifdef HAVE_BACKTRACE
 			BT_pcInfo (str, (intptr_t) packet->owner);
+#endif
 			Sys_Printf ("QFV_PacketAcquire: long acquire %'d for %p:%s\n",
 						(int) (end - start), stage, str->str);
 			dstring_delete (str);
diff --git a/nq/source/host.c b/nq/source/host.c
index 79d6861792..431dbdb0ab 100644
--- a/nq/source/host.c
+++ b/nq/source/host.c
@@ -913,7 +913,9 @@ void
 Host_Init (void)
 {
 	qfZoneScoped (true);
+#ifdef HAVE_BACKTRACE
 	BT_Init (com_argv[0]);
+#endif
 	Sys_RegisterShutdown (Host_Shutdown, 0);
 	Sys_Printf ("Host_Init\n");
 
diff --git a/ruamoko/qwaq/builtins/graphics.c b/ruamoko/qwaq/builtins/graphics.c
index 70a11e91df..f8e8d17ac0 100644
--- a/ruamoko/qwaq/builtins/graphics.c
+++ b/ruamoko/qwaq/builtins/graphics.c
@@ -40,7 +40,9 @@ static __attribute__ ((used)) const char rcsid[] = "$Id$";
 #include <errno.h>
 #include <string.h>
 
+#ifdef HAVE_BACKTRACE
 #include "QF/backtrace.h"
+#endif
 #include "QF/cbuf.h"
 #include "QF/draw.h"
 #include "QF/image.h"
@@ -456,8 +458,9 @@ BI_Graphics_Init (progs_t *pr)
 	qwaq_thread_t *thread = PR_Resources_Find (pr, "qwaq_thread");
 
 	PR_RegisterBuiltins (pr, builtins, 0);
+#ifdef HAVE_BACKTRACE
 	BT_Init (this_program);
-
+#endif
 	QFS_SetConfig (PL_GetPropertyList (bi_dirconf, nullptr));
 	QFS_Init (thread->hunk, "qwaq");
 	PI_Init ();
