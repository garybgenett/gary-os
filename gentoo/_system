#!/usr/bin/env bash
source ${HOME}/.bashrc
################################################################################

declare SOURCE="/.g/_data/_target/iso"

declare TARGET="/.g/_data/_build/_gentoo"
declare TOOR="-t"
if [[ ${1} == -t ]]; then
	shift
	TARGET="/.g/_toor"
	TOOR="-t"
fi

########################################

declare AUTO=
declare ASK="--ask y"
if [[ ${1} == -a ]]; then
	shift
	AUTO="-a"
	ASK="--ask n"
fi

declare BLD="false"
declare KRN="false"
declare CFG="false"
if [[ ${1} == -b ]]; then
	shift
	BLD="true"
fi
if [[ ${1} == -k ]]; then
	shift
	KRN="true"
fi
if [[ ${1} == -c ]]; then
	shift
	CFG="true"
fi

########################################

declare SAFE_ENV="prompt -z EMERGE_DEFAULT_OPTS="
if [[ ${1} == -i ]] || [[ ${1} == -s ]]; then
	SAFE_ENV="prompt -z chroot ${TARGET}"
elif [[ ${1} == -u ]]; then
	SAFE_ENV="prompt -z"
fi

################################################################################

if [[ ${1} == -s ]]; then
	${SAFE_ENV} /usr/bin/env bash -o vi
	exit 0
fi

########################################

if [[ ${1} == -0 ]]; then ${_SELF} ${TOOR} -a -b -k -i	; exit 0; fi
if [[ ${1} == -/ ]]; then ${_SELF} ${TOOR} -a -i	; exit 0; fi
if [[ ${1} == -1 ]]; then ${_SELF} ${TOOR} -a -b -i	; exit 0; fi
if [[ ${1} == -2 ]]; then ${_SELF} ${TOOR} -c -i	; exit 0; fi

########################################

if [[ ${1} == -i ]]; then
	umount					${TARGET}/dev/*	2>/dev/null
	umount					${TARGET}/*	2>/dev/null
	if [[ ! -d ${TARGET}/boot ]]; then
#>>>		tar -jpvvx -C ${TARGET} -f	$(ls ${SOURCE}/stage3-i686-*.tar.bz2	| tail -n1)
		tar -jpvvx -C ${TARGET} -f	$(ls ${SOURCE}/stage3-amd64-*.tar.bz2	| tail -n1)
		tar -jpvvx -C ${TARGET}/usr -f	$(ls ${SOURCE}/portage-*.tar.bz2	| tail -n1)
		${MKDIR}			${TARGET}/_build
		${RSYNC_U} ${SOURCE}/handbook-*	${TARGET}/_build/
		${RSYNC_U} ${SOURCE}/portage-*	${TARGET}/_build/
		${RSYNC_U} ${SOURCE}/stage3-*	${TARGET}/_build/
	fi
	mount -v --bind /dev			${TARGET}/dev
	mount -v --bind /dev/pts		${TARGET}/dev/pts
	mount -v --bind /proc			${TARGET}/proc
	mount -v --bind /sys			${TARGET}/sys
	${MKDIR}				${TARGET}/.g/.home
	${HOME}/scripts/_sync _home _build	${TARGET}/.g/.home
	${RM}					${TARGET}/.g/.home/.ssh/id_*
	HOME=/.g/.home ${SAFE_ENV}		/.g/.home/scripts/_sync mount g sda
	HOME=/.g/.home ${SAFE_ENV}		/.g/.home/setup/.setconf
	if ${BLD}; then
		${SAFE_ENV}			locale-gen						|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} ccache debugedit portage glibc gcc	|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} eselect genkernel gentoolkit		|| exit 1
		${SAFE_ENV}			eselect profile set 1					|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} --emptytree system world			|| exit 1
	fi
	if ${KRN}; then for KRN in $(
		${SED} -n "s/^['][=]gentoo-sources-(.+)[']$/\1/gp" ${HOME}/setup/gentoo/.packages
	); do
		${RM}				${TARGET}/usr/src/linux					|| exit 1
		${LN} linux-${KRN}-gentoo	${TARGET}/usr/src/linux					|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} =gentoo-sources-${KRN}			|| exit 1
		if [[ -z ${AUTO} ]]; then
		HOME=/.g/.home ${SAFE_ENV}	genkernel --loglevel=5 --symlink kernel --menuconfig	|| exit 1; else
		HOME=/.g/.home ${SAFE_ENV}	genkernel --loglevel=5 --symlink kernel			\
						--kernel-config=/.setup/linux/config-gentoo64-${KRN}	|| exit 1; fi
#>>>		KRN="kernel-genkernel-x86-${KRN}-gentoo"						|| exit 1
		KRN="kernel-genkernel-x86_64-${KRN}-gentoo"						|| exit 1
		${RM}				${TARGET}/boot/_cur					|| exit 1
		${LN} ${KRN}			${TARGET}/boot/_cur					|| exit 1
		${RM}				${TARGET}/boot/_new					|| exit 1
		${LN} kernel			${TARGET}/boot/_new					|| exit 1
		${RM}				${TARGET}/boot/_old					|| exit 1
		${LN} kernel.old		${TARGET}/boot/_old					|| exit 1
	done; fi
	if ${CFG}; then
		cat >>${TARGET}/etc/passwd <<END_OF_FILE
---
root:x:0:0::/.g/_data/zactive/.home:/bin/bash
plastic:x:1000:1000::/.g/_data/zactive/.home:/bin/bash
user:x:1001:1001::/.g/_data/zactive/.home:/bin/bash
null:x:666:666::/tmp/.null:/bin/nologin
---
END_OF_FILE
		cat >>${TARGET}/etc/shadow <<END_OF_FILE
---
root::::::::
plastic::::::::
user:*:::::::
null:*:::::::
---
END_OF_FILE
		cat >>${TARGET}/etc/group <<END_OF_FILE
---
root:x:0:root,plastic
wheel:x:10:root,plastic
plastic:x:1000:root,plastic
user:x:1001:root,plastic,user
null:x:666:root,plastic,null
---
audio:x:---:root,plastic,null
cdrom:x:---:root,plastic,null
video:x:---:root,plastic,null
games:x:---:root,plastic,null
---
END_OF_FILE
		cat >>${TARGET}/etc/gshadow <<END_OF_FILE
---
root:::root,plastic
wheel:::root,plastic
plastic:::root,plastic
user:::root,plastic,user
null:::root,plastic,null
---
audio:::root,plastic,null
cdrom:::root,plastic,null
video:::root,plastic,null
games:::root,plastic,null
---
END_OF_FILE
		cat >>${TARGET}/etc/pam.d/su <<END_OF_FILE
---
auth sufficient pam_wheel.so use_uid trust
auth required pam_wheel.so use_uid
---
END_OF_FILE
		cat >>${TARGET}/etc/sudoers <<END_OF_FILE
---
root ALL=(ALL) ALL
%wheel ALL=(ALL) ALL
%wheel ALL=(ALL) NOPASSWD: ALL
---
END_OF_FILE
		${EDITOR}			${TARGET}/etc/passwd	\
						${TARGET}/etc/shadow	\
						${TARGET}/etc/group	\
						${TARGET}/etc/gshadow	\
						${TARGET}/etc/pam.d/su	\
						${TARGET}/etc/sudoers
		for USER in			root	\
						plastic
		do				echo "password: ${USER}"
			until			${SAFE_ENV} passwd ${USER}
			do			echo "retry: ${USER}"
			done
		done
	fi
	HOME=/.g/.home ${SAFE_ENV}		${_SELF} ${AUTO} -f	|| exit 1
	HOME=/.g/.home ${SAFE_ENV}		${_SELF} ${AUTO} -u	|| exit 1
	umount					${TARGET}/dev/*	2>/dev/null
	umount					${TARGET}/*	2>/dev/null
	exit 0
fi

################################################################################

if [[ ${1} == -u ]]; then
	${LL} /_gentoo
	cat /_gentoo/+okay
	locale-gen
	gcc-config ${CHOST}-$(equery list gcc | awk '{print $1;}' | cut -d- -f3 | sort -n | tail -n1)
	gcc-config --list-profiles
	java-config --set-system-vm $(equery list oracle-jdk-bin | awk '{print $1;}' | cut -d/ -f2 | cut -d. -f-2 | sort -n | tail -n1)
	java-config --list-available-vms
	for SELECT in \
		mesa:--auto		\
		opengl:xorg-x11		\
		python:python3.2	\
		unison:2.45		\
		vi:gvim			\
		\
		package-manager:portage	\
		profile:1
	do
		declare KEY="$(echo "${SELECT}" | ${SED} "s/^(.+)[:](.+)$/\1/g")"
		declare VAL="$(echo "${SELECT}" | ${SED} "s/^(.+)[:](.+)$/\2/g")"
		eselect ${KEY} set ${VAL}
		eselect ${KEY} list
	done
	cat /dev/null >/var/lib/portage/world
	declare ECLEAN="eclean --verbose --destructive" #>>> --package-names
	${SAFE_ENV} emerge ${ASK} --update --deep --newuse system				|| exit 1
	${SAFE_ENV} emerge ${ASK} --noreplace --select $(${HOME}/setup/gentoo/.packages)	|| exit 1
	${SAFE_ENV} emerge ${ASK} --update --deep --newuse world				|| exit 1
	${SAFE_ENV} dispatch-conf								|| exit 1
	${SAFE_ENV} emerge --depclean								|| exit 1
	${SAFE_ENV} revdep-rebuild --ignore							|| exit 1
	${SAFE_ENV} module-rebuild populate							|| exit 1
	${SAFE_ENV} module-rebuild rebuild							|| exit 1
	${SAFE_ENV} emaint --fix all								|| exit 1
	${SAFE_ENV} ${ECLEAN} distfiles --fetch-restricted					|| exit 1
	${SAFE_ENV} ${ECLEAN} packages								|| exit 1

########################################

elif [[ ${1} != -! ]]; then
	if [[ ${1} != -f ]]; then
		${SAFE_ENV} emerge --verbose --sync
	fi
	${SAFE_ENV} emerge --emptytree --fetch-all-uri system world
fi

################################################################################

${RSYNC_U} ${HOME}/setup/gentoo/ /_gentoo/_gentoo

${SAFE_ENV} ${HOME}/setup/gentoo/.emergent
${SAFE_ENV} ${HOME}/setup/gentoo/.hacks

########################################

if [[ -z ${AUTO} ]] && [[ ${1} == -u ]]; then
	eselect news read new
fi

########################################

echo -en "\n"
wc -l /_gentoo/_packages
wc -l /_gentoo/_packages.db
diff  /_gentoo/_packages.db /_gentoo/_packages |
	${GREP} "^[<>]"

echo -en "\n"
${LL} /_gentoo/+okay*

exit 0
################################################################################
# end of file
################################################################################
