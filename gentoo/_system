#!/usr/bin/env bash
source ${HOME}/.bashrc
################################################################################

declare SOURCE="/.g/_data/_target/iso"
declare GITDIR="/.g/_data/_build/funtoo/meta-repo.git"
declare METDIR="/.g/_data/_builds/_metro"

declare SETDIR="${HOME}/setup"
declare FUNDIR="${SETDIR}/gentoo"
declare LINDIR="${SETDIR}/linux"

declare TARGET="/.g/_data/_builds/_gentoo"
declare TOOR=
declare _NEW="NEW"
declare _PKG="packages"
if [[ ${1} == -t ]]; then
	shift
	TARGET="/.g/_toor"
	TOOR="-t"
fi
if [[ ${1} == -m ]] || [[ ${1} == -~ ]]; then
	[[ ${1} == -~ ]] || shift
	TARGET="/.g/_toor"
	TOOR="-m"
	_NEW="MET"
	_PKG="metro"
fi

########################################

declare FILE=
declare NEXT=

########################################

declare FUNTOO_VER="$(tail -n1 ${FUNDIR}/funtoo)"
declare KERNEL_VER="$(${SED} -n "s|^.+/gentoo-sources:(.+)$|\1|gp" ${FUNDIR}/sets/${_PKG})"

declare COMMIT=
for FILE in \
	.setup	\
	.static
do
	COMMIT="${COMMIT}${FILE}: $(
		cat /.g/_data/zactive/${FILE}.git/refs/heads/master 2>/dev/null
	)\n"
done

########################################

declare AUTO=
declare ASK="--ask y"
if [[ ${1} == -a ]]; then
	shift
	AUTO="-a"
	ASK="--ask n"
fi

declare NEW="false"
declare BLD="false"
declare KRN="false"
declare CFG="false"
if [[ ${1} == -n ]]; then
	shift
	NEW="true"
fi
if [[ ${1} == -b ]]; then
	shift
	BLD="true"
fi
if [[ ${1} == -k ]]; then
	shift
	KRN="true"
fi
if [[ ${1} == -c ]]; then
	shift
	CFG="true"
fi

########################################

declare SAFE_ENV="prompt -z EMERGE_DEFAULT_OPTS="
if [[ ${1} == -i ]] || [[ ${1} == -s ]]; then
	SAFE_ENV="prompt -z chroot ${TARGET}"
elif [[ ${1} == -u ]]; then
	SAFE_ENV="eval prompt -z"
fi

################################################################################

if [[ ${1} == -s ]]; then
	${SAFE_ENV} /usr/bin/env bash -o vi "${@}"
	exit 0
fi

########################################

if [[ ${1} == -l ]]; then
	shift
	if [[ -n ${1} ]]; then
		FILE="$(ls -d /var/git/meta-repo/kits/*/*/${1})"
		NEXT="$(echo "${FILE}" | ${SED} "s|^/var/git/meta-repo/kits/.+[/]([^/]+[/][^/]+)$|\1|g")"
		if [[ -n ${FILE} ]]; then
			echo -en "https://gentoobrowse.randomdan.homeip.net/package/${NEXT}#bugs\n"
		fi
	fi
	exit 0
fi

################################################################################

if [[ ${1} == -0 ]]; then ${_SELF} ${TOOR} -a -n -b -k -i	| prompt -c	; exit 0; fi
if [[ ${1} == -/ ]]; then ${_SELF} ${TOOR} -a -i		| prompt -c	; exit 0; fi
if [[ ${1} == -1 ]]; then ${_SELF} ${TOOR} -a -b -i		| prompt -c	; exit 0; fi
if [[ ${1} == -2 ]]; then ${_SELF} ${TOOR} -c -i				; exit 0; fi

if [[ ${1} == -~ ]]; then
	if [[ -n $(find ${TARGET} -maxdepth 0 -empty) ]]; then
#>>>		tar -pvvxJ -C ${TARGET} -f		$(ls -t ${METDIR}/stage3-*i686*funtoo*.tar.xz		| head -n1)
		tar -pvvxJ -C ${TARGET} -f		$(ls -t ${METDIR}/stage3-*core2_64*funtoo*.tar.xz	| head -n1)
		tar -pvvxJ -C ${TARGET}/usr -f		$(ls -t ${METDIR}/portage-*.tar.xz			| head -n1)
		${RSYNC_U} ${METDIR}/.distfiles/	${TARGET}/usr/portage/distfiles
	fi
	${_SELF} ${TOOR} -a -n -i | prompt -c
	exit 0
fi

########################################

if [[ ${1} == -i ]]; then
	umount					${TARGET}/{dev{/pts,/shm,},proc,sys}	2>/dev/null
	if [[ ! -d ${TARGET}/boot ]]; then
#>>>		tar -pvvxJ -C ${TARGET} -f	$(ls -t ${SOURCE}/stage3-*i686*funtoo*.tar.xz		| head -n1)
		tar -pvvxJ -C ${TARGET} -f	$(ls -t ${SOURCE}/stage3-*core2_64*funtoo*.tar.xz	| head -n1)
		${RSYNC_U} ${SOURCE}/*funtoo*	${TARGET}/_build/
	fi
	echo -en "${COMMIT}"			>${TARGET}/_build/_commit
	${RSYNC_U} ${FUNDIR}/			${TARGET}/_build/_config
	${RSYNC_U} ${LINDIR}/			${TARGET}/_build/_kernel
	mount -v --bind /dev			${TARGET}/dev
	mount -v --bind /dev/pts		${TARGET}/dev/pts
	mount -v --bind /dev/shm		${TARGET}/dev/shm
	mount -v --bind /proc			${TARGET}/proc
	mount -v --bind /sys			${TARGET}/sys
	${MKDIR}				${TARGET}/.g/.home
	${HOME}/scripts/_sync _home _build	${TARGET}/.g/.home
	${RM}					${TARGET}/.g/.home/.ssh/id_*
	HOME=/.g/.home ${SAFE_ENV}		/.g/.home/scripts/_sync mount g null
	if [[ ! -d ${TARGET}/var/git/meta-repo ]]; then
		${MKDIR}			${TARGET}/var/git/meta-repo{,.git}
		${RSYNC_U} ${GITDIR}/		${TARGET}/var/git/meta-repo.git
		HOME=/.g/.home ${SAFE_ENV}	${_SELF} ${FUNTOO_VER}
	fi
	HOME=/.g/.home ${SAFE_ENV}		/.g/.home/setup/.setconf -r
	if ${NEW}; then
		if [[ ${_NEW} == "MET" ]]; then
			${SED} -i "N;N;N;N;N;s|[\"]\n\nMETRO_USE=[^\n]+\n||g" ${TARGET}/.setup/gentoo/make.conf
		fi
		for NEW in \
			${TARGET}/.setup/gentoo/package.*
		do
			${SED} -i "s|^[#][{]${_NEW}[}][ ](.+)$|\1|g" ${NEW}
		done
	fi
	if ${BLD}; then
		${SAFE_ENV}			locale-gen						|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} ccache debugedit portage glibc gcc	|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} eselect genkernel gentoolkit		|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} debian-sources				|| exit 1
		${SAFE_ENV}			eselect profile set-build 25				|| exit 1	# stable
		${SAFE_ENV}			eselect profile set-flavor 30				|| exit 1	# desktop
		${SAFE_ENV}			epro show						|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} --emptytree \@system \@world		|| exit 1
	fi
	if ${KRN}; then for FILE in ${KERNEL_VER}; do
		${RM}				${TARGET}/usr/src/linux					|| exit 1
		${LN} linux-${FILE}-gentoo	${TARGET}/usr/src/linux					|| exit 1
		HOME=/.g/.home ${SAFE_ENV}	emerge ${ASK} =gentoo-sources-${FILE}			|| exit 1
		declare GENKERNEL_OPTS="--loglevel=5 --bootloader=grub --symlink kernel"
		if [[ -z ${AUTO} ]]; then
		HOME=/.g/.home ${SAFE_ENV}	genkernel ${GENKERNEL_OPTS} kernel --menuconfig		|| exit 1; else
		HOME=/.g/.home ${SAFE_ENV}	genkernel ${GENKERNEL_OPTS} kernel			\
						--kernel-config=${LINDIR}/config-gentoo64-${FILE}	|| exit 1; fi
#>>>		FILE="kernel-genkernel-x86-${FILE}-gentoo"						|| exit 1
		FILE="kernel-genkernel-x86_64-${FILE}-gentoo"						|| exit 1
		${RM}				${TARGET}/boot/_cur					|| exit 1
		${LN} ${FILE}			${TARGET}/boot/_cur					|| exit 1
		${RM}				${TARGET}/boot/_new					|| exit 1
		${LN} kernel			${TARGET}/boot/_new					|| exit 1
		${RM}				${TARGET}/boot/_old					|| exit 1
		${LN} kernel.old		${TARGET}/boot/_old					|| exit 1
		{ [[ -L				${TARGET}/boot/kernel.old ]] ||
		${LN} ${FILE}			${TARGET}/boot/kernel.old; }				|| exit 1
	done; fi
	declare KERNEL="$(cd ${TARGET}/boot; ls kernel-debian-sources-*		2>/dev/null | sort | tail -n1)"
	declare INITRD="$(cd ${TARGET}/boot; ls initramfs-debian-sources-*	2>/dev/null | sort | tail -n1)"
	if [[ -n ${KERNEL} ]]; then
		${RM}				${TARGET}/boot/_kernel					|| exit 1
		${LN} ${KERNEL}			${TARGET}/boot/_kernel					|| exit 1
	fi
	if [[ -n ${INITRD} ]]; then
		${RM}				${TARGET}/boot/_initrd					|| exit 1
		${LN} ${INITRD}			${TARGET}/boot/_initrd					|| exit 1
	fi
	if ${CFG}; then
		cat >>${TARGET}/etc/passwd <<END_OF_FILE
---
root:x:0:0::/.g/_data/zactive/.home:/bin/bash
plastic:x:1000:1000::/.g/_data/zactive/.home:/bin/bash
user:x:1001:1001::/.g/_data/zactive/.home:/bin/bash
null:x:666:666::/tmp/.null:/bin/nologin
lfs-user:x:9999:9999::/.g/_data/_build/_lfs/.lfs/lfs-user:/bin/bash
---
END_OF_FILE
		cat >>${TARGET}/etc/shadow <<END_OF_FILE
---
root::::::::
plastic::::::::
user:*:::::::
null:*:::::::
lfs-user:*:::::::
---
END_OF_FILE
		cat >>${TARGET}/etc/group <<END_OF_FILE
---
root:x:0:root,plastic
wheel:x:10:root,plastic,lfs-user
plastic:x:1000:root,plastic
user:x:1001:root,plastic,user
null:x:666:root,plastic,null
lfs-user:x:9999:root,plastic,lfs-user
---
audio:x:---:root,plastic,null
cdrom:x:---:root,plastic,null
video:x:---:root,plastic,null
games:x:---:root,plastic,null
---
END_OF_FILE
		cat >>${TARGET}/etc/gshadow <<END_OF_FILE
---
root:::root,plastic
wheel:::root,plastic,lfs-user
plastic:::root,plastic
user:::root,plastic,user
null:::root,plastic,null
lfs-user:::root,plastic,lfs-user
---
audio:::root,plastic,null
cdrom:::root,plastic,null
video:::root,plastic,null
games:::root,plastic,null
---
END_OF_FILE
		cat >>${TARGET}/etc/pam.d/su <<END_OF_FILE
---
auth sufficient pam_wheel.so use_uid trust
auth required pam_wheel.so use_uid
---
END_OF_FILE
		cat >>${TARGET}/etc/sudoers <<END_OF_FILE
---
Defaults exempt_group=wheel
%wheel ALL=(ALL) ALL
%wheel ALL=(ALL) NOPASSWD: ALL
---
END_OF_FILE
		${EDITOR}			${TARGET}/etc/passwd	\
						${TARGET}/etc/shadow	\
						${TARGET}/etc/group	\
						${TARGET}/etc/gshadow	\
						${TARGET}/etc/pam.d/su	\
						${TARGET}/etc/sudoers
		for FILE in			root	\
						plastic
		do				echo "password: ${FILE}"
			until			${SAFE_ENV} passwd ${FILE}
			do			echo "retry: ${FILE}"
			done
		done
	fi
	HOME=/.g/.home ${SAFE_ENV}		${_SELF} ${TOOR} ${AUTO} -f	|| exit 1
	HOME=/.g/.home ${SAFE_ENV}		${_SELF} ${TOOR} ${AUTO} -u	|| exit 1
	umount					${TARGET}/{dev{/pts,/shm,},proc,sys}	2>/dev/null
	exit 0
fi

################################################################################

if [[ ${1} == -u ]]; then
	${RSYNC_U/reporter} ${FUNDIR}/[a-z_]*		/etc/portage/
	${LN} /etc/portage/_overlay/overlay.conf	/etc/portage/repos.conf/
	chown -R root:root				/etc/portage
	chmod -R 755					/etc/portage
	${LL} /_gentoo
	cat /_gentoo/+okay
	locale-gen
	gcc-config ${CHOST}-$(equery list gcc | awk '{print $1;}' | cut -d- -f3 | sort -n | tail -n1)
	gcc-config --list-profiles
	java-config --set-system-vm $(equery list icedtea | awk '{print $1;}' | ${GREP} -v "^$" | cut -d/ -f2 | cut -d. -f1 | tail -n1)
	java-config --list-available-vms
	eselect profile set-build 25	# stable
	eselect profile set-flavor 30	# desktop
	epro show
	for FILE in \
		mesa:--auto		\
		opengl:xorg-x11		\
		python:python3.3	\
		unison:2.45		\
		vi:vim			\
		\
		$(for NEXT in ${KERNEL_VER}; do
			echo "kernel:linux-${NEXT}-gentoo"
		done)
	do
		declare KEY="$(echo "${FILE}" | ${SED} "s/^(.+)[:](.+)$/\1/g")"
		declare VAL="$(echo "${FILE}" | ${SED} "s/^(.+)[:](.+)$/\2/g")"
		eselect ${KEY} set ${VAL}
		eselect ${KEY} list
	done
	cat /dev/null	>/var/lib/portage/world
	echo "@${_PKG}"	>/var/lib/portage/world_sets
	declare EXPECT_W="expect-wrapper"
	function expect-wrapper {
		declare EXPECT_CMD="expect -c \"spawn ${@};"
		EXPECT_CMD+=" "; EXPECT_CMD+="expect yes/no {send y\\r; exp_continue;};"
		EXPECT_CMD+=" "; EXPECT_CMD+="expect use-new {send u\\r; exp_continue;};"
		EXPECT_CMD+="\""
		if [[ -n ${AUTO} ]]; then
			${SAFE_ENV} $(echo ${EXPECT_CMD})
		else
			${SAFE_ENV} ${@}
		fi
	}
#>>>	${SAFE_ENV} emerge ${ASK} --update --deep --newuse \@system		|| exit 1
#>>>	${SAFE_ENV} emerge ${ASK} --update --deep --newuse \@world		|| exit 1
	${SAFE_ENV} emerge ${ASK} --update --deep --newuse \@system \@world	|| exit 1
#>>>	${EXPECT_W} python-updater						|| exit 1
	${EXPECT_W} perl-cleaner --all						|| exit 1
	${EXPECT_W} haskell-updater --all					|| exit 1
	${SAFE_ENV} emerge ${ASK} \@preserved-rebuild				|| exit 1
#>>>	${SAFE_ENV} emerge ${ASK} \@module-rebuild				|| exit 1
	${SAFE_ENV} emerge ${ASK} --depclean					|| exit 1
	${SAFE_ENV} revdep-rebuild --ignore					|| exit 1
	${SAFE_ENV} emaint --fix all						|| exit 1
	${SAFE_ENV} eclean --verbose distfiles					|| exit 1
	${SAFE_ENV} eclean --verbose packages					|| exit 1
	${EXPECT_W} dispatch-conf						|| exit 1

########################################

elif [[ ${1} != -! ]]; then
	if [[ ${1} != -f ]]; then
		declare GIT="$(which git)"
		if [[ -d /var/git/meta-repo.git ]] && [[ ! -d /var/git/meta-repo/.git ]]; then
			${MV} /var/git/meta-repo.git /var/git/meta-repo/.git
		fi
#>>>		${SAFE_ENV} emerge --ask=n --verbose --sync			|| exit 1
		${SAFE_ENV} ego sync						|| exit 1
		if [[ -z ${1} ]]; then
			(cd /var/git/meta-repo &&
				${GIT} pull &&
				${GIT} checkout --force master &&
				${GIT} submodule update --force --init --recursive --remote --rebase &&
				${GIT} submodule foreach --recursive "git reset --hard"
			)							|| exit 1
		else
			(cd /var/git/meta-repo &&
				${GIT} reset --hard ${1} &&
				${GIT} submodule update --force --init --recursive &&
				${GIT} submodule foreach --recursive "git reset --hard"
			)							|| exit 1
		fi
		if [[ -d /var/git/meta-repo/.git ]] && [[ ! -d /var/git/meta-repo.git ]]; then
			${MV} /var/git/meta-repo/.git /var/git/meta-repo.git
		fi
	fi
	${SAFE_ENV} emerge --ask=n --emptytree --fetch-all-uri \@system \@world
#>>>	${SAFE_ENV} egencache --update-use-local-desc
fi

################################################################################

${SAFE_ENV} ${FUNDIR}/.emergent
${SAFE_ENV} ${FUNDIR}/.hacks

########################################

if [[ -z ${AUTO} ]] && [[ ${1} == -u ]]; then
	eselect news read new
fi

########################################

echo -en "\n"
wc -l /_gentoo/_packages
wc -l /_gentoo/_packages.db
diff  ${DIFF_OPTS} /_gentoo/_packages.db /_gentoo/_packages |
	${GREP} "^[<>]"

echo -en "\n"
${LL} /_gentoo/+okay*

exit 0
################################################################################
# end of file
################################################################################
