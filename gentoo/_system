#!/usr/bin/env bash
source ${HOME}/.bashrc
################################################################################

declare SAFE_ENV="prompt -z EMERGE_DEFAULT_OPTS="
if [[ ${1} == -u ]]; then
	SAFE_ENV="prompt -z"
fi

################################################################################

if [[ ${1} == -u ]]; then
	${LL} /_gentoo
	cat /_gentoo/+okay
	cat /dev/null >/var/lib/portage/world
	declare COMMAND
	${SED} -n \
		-e "s/^#[[:space:]]+(gcc-config[ ].+$)/\1/gp" \
		-e "s/^#[[:space:]]+(java-config[ ].+$)/\1/gp" \
		-e "s/^#[[:space:]]+(eselect[ ].+[ ]set[ ].+$)/\1/gp" \
		${HOME}/setup/gentoo/make.conf |
	while read -r COMMAND
	do
		eval ${COMMAND}
	done
	${SAFE_ENV} emerge --update --deep --newuse system				|| exit 1
	${SAFE_ENV} emerge --noreplace --select $(${HOME}/setup/gentoo/.packages)	|| exit 1
	${SAFE_ENV} emerge --update --deep --newuse world				|| exit 1
	${SAFE_ENV} dispatch-conf							|| exit 1
	${SAFE_ENV} emerge --depclean							|| exit 1
	${SAFE_ENV} revdep-rebuild --ignore						|| exit 1
	${SAFE_ENV} emaint --fix all							|| exit 1
	${SAFE_ENV} equery list --duplicates '*'
else
	${SAFE_ENV} emerge --verbose --sync
	${SAFE_ENV} emerge --emptytree --fetch-all-uri system world
fi

########################################

${SAFE_ENV} ${HOME}/setup/gentoo/.emergent
${SAFE_ENV} ${HOME}/setup/gentoo/.hacks

exit 0
################################################################################
# end of file
################################################################################
