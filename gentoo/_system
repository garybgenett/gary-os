#!/usr/bin/env bash
source ${HOME}/.bashrc
################################################################################

if { [[ -z ${_BASHED} ]] || ! ${_BASHED}; }; then
	echo -en "\n"
	echo -en ">>> THE GARYOS BASHRC FILE MUST BE IN YOUR HOME DIRECTORY <<<\n"
	echo -en ">>> OR YOU CAN SET THE HOME VARIABLE TO THE LOCATION WHERE IT IS <<<\n"
	echo -en "\n"
	exit 1
fi

########################################

declare _SOUL="${_SELF}"
declare _HEART="${SCRIPT}"
declare _BASH_SOURCED="false"; $(return >/dev/null 2>&1)
if [[ ${?} == 0 ]]; then
	_SOUL="${BASH_SOURCE}"
	_HEART="$(basename -- "${_SOUL}")"
	_BASH_SOURCED="true"
fi

########################################

export _SYSTEMED="true"

################################################################################

#{CMD} grep -oE "[!=][=][ ][-][^[:space:]]+" ./gentoo/_system | sed -r "s|^[!=][=][[:space:]]+||g" | sort -u

export _OPTS="${@}"

########################################

export DEBUG_OPT="-v"
export QUIET_OPT="-q"

export DEBUG="false"
export QUIET="false"
if ! ${_BASH_SOURCED}; then
	if [[ ${1} == ${DEBUG_OPT} ]]; then
		DEBUG="true"
		shift
	fi
	if [[ ${1} == ${QUIET_OPT} ]]; then
		QUIET="true"
		shift
	fi
fi

########################################

declare EMERGE_TREE_OPTS="--tree --unordered-display"
declare EMERGE_UPDT_OPTS="${EMERGE_TREE_OPTS} --deep --newuse --update"

########################################

declare FILE=
declare NEXT=

################################################################################

#NOTE: UPDATE THESE WHEN THEY CHANGE IN THE "${MAKEIT}" SCRIPT
#NOTE: VALUES FOR "FUNTOO" ARE BELOW

#SETTINGS[_GNAME _TITLE _VERSN _RDATE]
#SETTINGS[FUNTOO FUNDAT]
#SETTINGS[_FINAL _RAMFS]
#SETTINGS[_GOVLY _GUNPK _GINST]
#SETTINGS[_GREAD _GPACK]

export _TITLE="gary-os"

########################################

#>>> grep -iE -e "[{](ismain|isexit)[}]" -e "[{](rootfs|domods|doredo|dofast|dotest)[}]" -e "(rootfs|domods|doredo|dofast|dotest)[=]" ./gentoo/_system ./gentoo/_release ./gentoo/sets/*
#>>> | grep "function"

#OPTIONS[ROOTFS DOMODS]
if [[ ${ROOTFS} != true ]] && [[ ${ROOTFS} != false ]]; then ROOTFS="true"; fi
if [[ ${DOMODS} != true ]] && [[ ${DOMODS} != false ]]; then DOMODS="false"; fi

#OPTIONS[DOREDO DOFAST DOTEST]
if [[ ${DOREDO} != true ]] && [[ ${DOREDO} != false ]]; then DOREDO="false"; fi
if [[ ${DOFAST} != true ]] && [[ ${DOFAST} != false ]]; then DOFAST="false"; fi
if [[ ${DOTEST} != true ]] && [[ ${DOTEST} != false ]]; then DOTEST="false"; fi

########################################

#OPTIONS[SOURCE GITDIR]
export SOURCE="${SOURCE:-/.g/_data/_target/iso}"
export GITDIR="${GITDIR:-https://anongit.gentoo.org/git/repo/gentoo}"

#>>> #OPTIONS[BLDDIR WRKDIR GOSDIR]
export BLDDIR="${BLDDIR:-/.g/_data/_builds/_gentoo}"
export WRKDIR="${WRKDIR:-${BLDDIR}.working}"
export GOSDIR="${GOSDIR:-/.g/_data/_builds/_${_TITLE}.working}"

#>>> #OPTIONS[BLDPKG WRKPKG TORPKG GOSPKG]
export BLDPKG="${BLDPKG:-packages}"
export WRKPKG="${WRKPKG:-${BLDPKG}}"
export TORPKG="${TORPKG:-${BLDPKG}}"
export GOSPKG="${GOSPKG:-${_TITLE}}"

########################################

#NOTE: THE "ARCDIR/GENDIR/_SYSTEM" VALUE IS HARD-SET IN "./GENDIR/LAYDIR/.REVIEW"
#NOTE: IT MUST BE UPDATED IF THESE VALUES CHANGE

#VARIABLES[ETCDIR DSTDIR PAKDIR REPDIR TMPDIR PDBDIR]
export ETCDIR="/etc/portage"
export DSTDIR="/var/cache/distfiles"
export PAKDIR="/var/cache/binpkgs"
export REPDIR="/var/db/repos/gentoo"
export TMPDIR="/var/tmp/portage"
export PDBDIR="/var/db/pkg"

#VARIABLES[ARCDIR GENDIR]
export ARCDIR="/_build"
export GENDIR="/_gentoo"

#VARIABLES[GRBDIR LINDIR FUNDIR]
export GRBDIR="grub"
export LINDIR="linux"
export FUNDIR="gentoo"

#VARIABLES[FUNCMT AUDITS LAYDIR]
export FUNCMT="_funtoo"
export AUDITS=".emergent"
export LAYDIR="overlay"

#OPTIONS[SETDIR CFGSCR ARTDIR]
export SETDIR="${SETDIR:-/.g/_data/zactive/.setup}"
export CFGSCR="${CFGSCR:-${SETDIR}/${FUNDIR}.config}"
export ARTDIR="${ARTDIR:-/.g/_data/zactive/coding/gary-os/artifacts}"

#NOTE: UPDATE THESE WHEN THEY CHANGE IN THE "${MAKEIT}" SCRIPT

#VARIABLES[PREPIT MAKEIT SHIPIT]
export PREPIT="_prepare"
export MAKEIT="_release"
export SHIPIT="_publish"

########################################

#NOTE: EXPRESSIONS FOR "FUNTOO" ARE ABOVE

#>>> #SETTINGS[FUNTOO FUNDAT]
declare FUNTOO="$(tail -n1 ${SETDIR}/${FUNDIR}/${FUNCMT} 2>/dev/null)"
declare FUNDAT="$(${SED} -n "s|^#.+([0-9]{4}-[0-9]{2}-[0-9]{2}).+(${FUNTOO/#* }).*$|\1|gp" ${SETDIR}/${FUNDIR}/${FUNCMT})"

########################################

#VARIABLES[TARGET TOOR _PKG _NEW _MOD _GOS _GFG]
export TARGET="${BLDDIR}"
export TOOR=
export _PKG="${BLDPKG}"
export _NEW="false"
export _MOD="false"
export _GOS="false"
export _GFG="false"

if ! ${_BASH_SOURCED}; then
	if [[ ${1} == -[dxg] ]]; then
		TOOR="${1}"
		shift
	fi
fi
if [[ ${TOOR} == -d ]]; then
	TARGET="${BLDDIR}"
	_PKG="${BLDPKG}"
fi
if [[ ${TOOR} == -x ]]; then
	if [[ ${SETDIR} == /.g/_data/zactive/.setup ]]; then
		SETDIR="${SETDIR}/${FUNDIR}.make"
	fi
	TARGET="${WRKDIR}"
	_PKG="${WRKPKG}"
fi
if [[ ${TOOR} == -g ]]; then
	if [[ ${SETDIR} == /.g/_data/zactive/.setup ]]; then
		SETDIR="${SETDIR}/${FUNDIR}.${_TITLE}"
	fi
	TARGET="${GOSDIR}"
	_PKG="${GOSPKG}"
fi
if [[ -e ${TARGET} ]]; then
	TARGET="$(realpath ${TARGET})"
	#note: this is a potentially dangerous way of stripping "//" to just "/" for pattern matching and pretty output
	TARGET="${TARGET/%\/}"
fi

#note: environment variable to select modified build with the makefile
#note: command line option overrides the environment variable
if ${DOMODS}; then
	_MOD="true"
fi

if ! ${_BASH_SOURCED}; then
	if [[ ${1} == -n ]]; then
		TOOR="${TOOR} ${1}"
		_NEW="true"
		shift
	fi
	if [[ ${1} == -m ]]; then
		TOOR="${TOOR} ${1}"
		_MOD="true"
		shift
	fi
fi

#note: detection of a "gary-os" build is based purely on the package set name
if [[ ${_PKG} == ${_TITLE} ]]; then
	_GOS="true"
	_GFG="true"
fi
#note: forcing unmodified configuration for full "_gary-os" build
if [[ ${_PKG} == _${_TITLE} ]]; then
	#note: this is a hidden, undocumented option for the author's personal setup
	#note: see "$fsupdt" in "gentoo/sets/_gary-os"
	#note: see "$fsupdt" in "gentoo/_release" (release_unpack)
#>>>	_MOD="false"
	_GOS="true"
	_GFG="false"
fi

########################################

#VARIABLES[AUTO _ASK _BLD _KRN _CFG]
export AUTO=
export _ASK="--ask=y"
export _BLD="false"
export _KRN="false"
export _CFG="false"

if ! ${_BASH_SOURCED}; then
	if [[ ${1} == -a ]]; then
		AUTO="${1}"
		_ASK="--ask=n"
		shift
	fi
	if [[ ${1} == -b ]]; then
		_BLD="true"
		shift
	fi
	if [[ ${1} == -k ]]; then
		_KRN="true"
		shift
	fi
	if [[ ${1} == -c ]]; then
		_CFG="true"
		shift
	fi
fi

########################################

#OPTIONS[STAGE]
export STAGE="amd64-nomultilib-openrc"

#OPTIONS[_CPU EARC ESUB GARC GSUB GOPT]
export _CPU_RESET="CONFIG_GENERIC_CPU"
export _CPU="${_CPU:-${_CPU_RESET}}"
export EARC="${EARC:-x86-64bit}"
export ESUB="${ESUB:-generic_64}"
export GARC="${GARC:-x86-64}"
export GSUB="${GSUB:-generic}"
export GOPT="${GOPT:--O2}"

if ${_GOS}; then
	_CPU="CONFIG_GENERIC_CPU"
	EARC="x86-64bit"
	ESUB="generic_64"
	GARC="x86-64"
	GSUB="generic"
	GOPT="-O2"
fi

########################################

#{CMD} grep -rE "[#][{](NEW|MOD|GOS|CPU|GARC|GSUB|GOPT)[}]" ./gentoo

function portage_file {
	declare PORT_SEL="${1}" && shift
	declare P_FILTER="${1}" && shift
	declare P_SPACER="${1}" && shift
	if [[ -d ${PORT_SEL} ]]; then
		for FILE in $(${LS}		\
			${PORT_SEL}/make.conf	\
			${PORT_SEL}/package.*	\
			${PORT_SEL}/sets/*	\
			2>/dev/null)		\
		; do
			{ ${FUNCNAME} ${FILE} || return 1; }	>${FILE}.${FUNCNAME}	|| return 1
			${MV} ${FILE}.${FUNCNAME}		${FILE}			|| return 1
		done
	elif [[ -f ${PORT_SEL} ]]; then
		cat ${PORT_SEL} |
			{ { ${_NEW} &&			{ ${SED} -e "s|^[#][{]NEW[}][ ](.+)$|\1|g" -e "/[#][{]NEW[}]/d" || return 1; }; } || cat; } |
			{ { ${_MOD} &&			{ ${SED} -e "s|^[#][{]MOD[}][ ](.+)$|\1|g" -e "/[#][{]MOD[}]/d" || return 1; }; } || cat; } |
			{ { ${_GOS} && ${_GFG} &&	{ ${SED} -e "s|^[#][{]GOS[}][ ](.+)$|\1|g" -e "/[#][{]GOS[}]/d" || return 1; }; } || cat; } |
			{ { ${_GOS} && ! ${_GFG} &&	{ ${SED} -e "s|^[#][{]GFG[}][ ](.+)$|\1|g" -e "/[#][{]GFG[}]/d" || return 1; }; } || cat; } |
			{ {				{ ${SED} -e "s|^[#][{]CPU[}][ ](.+)$|\1|g" -e "/[#][{]CPU[}]/d" || return 1; }; } || cat; } |
			{ ${SED} \
				-e "s|[#][{]GARC[}]|${GARC}|g"	\
				-e "s|[#][{]GSUB[}]|${GSUB}|g"	\
				-e "s|[#][{]GOPT[}]|${GOPT}|g"	\
				|| return 1;
			} |
			{ {
				{
					[[ -n ${P_FILTER} ]] && [[ -n ${P_SPACER} ]];
				} && {
					{ ${SED} -n "s|^[#][{]${P_FILTER}[}][ ]([^#]+).*$|\1|gp"			|| return 1; } |
					{ tr '\n' '!'									|| return 1; } |
					{ ${SED} -e "s|[[:space:]]+| |g" -e "s|[! ]*$||g" -e "s|[!]|${P_SPACER}|g"	|| return 1; };
				};
			} || cat; } \
		2>/dev/null
	else
		return 1
	fi
	return 0
}

#OPTIONS[LINPKG KERNEL]
#OPTIONS[SELECT WINMGR WMHELP]
#OPTIONS[RCUPDT FSUPDT FSPACK FSKEEP FSARCH FSEXCL]
for FILE in	\
	LINPKG	\
	KERNEL	\
	\
	FLAVOR	\
	MIXINS	\
	\
	SELECT	\
	WINMGR	\
	WMHELP	\
; do
	eval export ${FILE}=\"${!FILE:-$(portage_file ${SETDIR}/${FUNDIR}/sets/${_PKG} ${FILE} " ")}\"
done
for FILE in	\
	RCUPDT	\
	FSUPDT	\
	FSPACK	\
	FSKEEP	\
	FSARCH	\
	FSEXCL	\
; do
	eval export ${FILE}=\"${!FILE:-$(portage_file ${SETDIR}/${FUNDIR}/sets/${_PKG} ${FILE} " ; ")}\"
done
export WINMGR="${WINMGR:-dwm}"
export WMHELP="${WMHELP:-${_TITLE} / \`date --iso=s\`}"

########################################

declare LDIR="/usr/src/linux"
declare MDIR="/lib64/modules"
declare FDIR="/lib64/firmware"

declare KVER=
declare KCFG=
declare KBAS=
declare KFIL=
declare KDIR=
for FILE in ${KERNEL}; do
	KVER="${FILE}"
	KCFG="config-gentoo64-${KVER}"
	KBAS="linux-${KVER}-gentoo"
	KFIL="kernel-genkernel-x86_64-${KVER}-gentoo"
	KDIR="/usr/src/${KBAS}"
done

########################################

#VARIABLES[HOME PWD MYSELF IS_CHROOT DO_CHROOT SAFE_ENV]
export MYSELF="${ARCDIR}/${FUNDIR}/${_HEART}"

if [[ ${IS_CHROOT} != true ]] && [[ ${IS_CHROOT} != false ]]; then export IS_CHROOT="false"; fi
export DO_CHROOT="false"
if ! ${IS_CHROOT} && [[ -n ${TOOR} ]]; then
	DO_CHROOT="true"
fi

export SAFE_ENV=
for FILE in $(${SED} -n "s|^.*[#]OPTIONS[[](.+)[]]$|\1|gp" ${_SOUL}); do
	SAFE_ENV+=" ${FILE}=\"${!FILE}\""
done
SAFE_ENV="${SAFE_ENV/#\ }"

if ${DO_CHROOT}; then
	function safe_env {
		declare C_TARGET="${TARGET}"
		if [[ -z ${TARGET} ]]; then
			C_TARGET="/"
		fi
		eval prompt -z IS_CHROOT=\"true\" ${SAFE_ENV} HOME=\"${ARCDIR}\" SETDIR=\"${ARCDIR}\" chroot \"${C_TARGET}\" '"${@}"' || return 1
		return 0
	}
else
	function safe_env {
		eval prompt -z IS_CHROOT=\"${IS_CHROOT}\" ${SAFE_ENV} '"${@}"' || return 1
		return 0
	}
fi

########################################

declare VARSREGEX="[A-Z][A-Z0-9_]+"
declare MASKREGEX="^[[:space:]]+(${VARSREGEX})([[:space:]].*)?$"
declare MASKVARS="
$(man make.conf 2>/dev/null | ${GREP} "${MASKREGEX}" | ${GREP} --only-matching "${VARSREGEX}")
CARCH
"
declare SKIPVARS="
DIR
URI
"
declare KEEPVARS="
${SKIPVARS}
PATH
"

function clear_environment {
	if ${QUIET}; then
		return 0
	fi
	for FILE in $(
		echo "${MASKVARS}" |
		${SED} "/^$/d" |
		sort --field-separator=" " --unique |
		${GREP} --invert-match "^($(
			echo "${KEEPVARS}" |
			${SED} "/^$/d" |
			tr '\n' '|' |
			${SED} -e "s|^[|]*||g" -e "s|[|]*$||g"
		))$"
	); do
		echo -en "${FILE}=${!FILE}\n" | ${GREP} "[=].+$"
		unset ${FILE}
	done
	return 0
}

################################################################################

#NOTE: TEST READABILITY WITHOUT COLORS (MAKEFILE ALSO)
#NOTE: https://unix.stackexchange.com/questions/58982/disable-colours-on-terminal-and-ssh
#NOTE: (TERM=ansi-mono ; tput colors ; dircolors -p | grep -x "TERM ${TERM}")
#NOTE: OR COMMENT COLOR DECLARATIONS

#NOTE: TRY TO KEEP OUTPUT IN THIS AND ${MAKEIT} SCRIPT TO 80 CHARACTERS WIDE
#>>>	print_info header

function print_info {
	if ${QUIET} && ! {
		! ${IS_CHROOT} && {
			[[ ${1} == "title" ]] ||
			[[ ${1} == "success" ]] ||
			[[ ${1} == "error" ]];
		};
	}; then
		return 0
	fi
	declare TITLE="\e[1;32m"	# light green
	declare STATE="\e[0;35m"	# magenta
	declare HOWTO="\e[0;36m"	# cyan
	declare NOTES="\e[0;33m"	# yellow
	declare ERROR="\e[1;31m"	# red
	declare OTHER="\e[1;34m"	# dark blue
	declare RESET="\e[0;37m"	# light gray
	if [[ ${1} == "marker" ]]; then
		echo -en "${OTHER}"
		printf "~%.0s" {1..80}
		echo -en "${RESET}\n"
	elif [[ ${1} == "header" ]]; then
		echo -en "${RESET}"
		printf ">%.0s" {1..80}
		echo -en "${RESET}\n"
	elif [[ ${1} == "title" ]]; then
		${QUIET} && QUIET="false" ${FUNCNAME} marker
		echo -en "${NOTES}"
		echo -en ">>> GARYOS BUILD SCRIPT <<<"
		echo -en "${RESET}\n"
		${QUIET} && QUIET="false" ${FUNCNAME} marker
	elif [[ ${1} == "success" ]]; then
		${QUIET} && QUIET="false" ${FUNCNAME} marker
		echo -en "${TITLE}"
		echo -en ">>> GARYOS BUILD SCRIPT: SUCCESS! <<<"
		echo -en "${RESET}\n"
		${QUIET} && QUIET="false" ${FUNCNAME} marker
	elif [[ ${1} == "error" ]]; then
		${QUIET} && QUIET="false" ${FUNCNAME} marker
		echo -en "${ERROR}"
		echo -en ">>> GARYOS BUILD SCRIPT: FAILURE! <<<"
		echo -en "${RESET}\n"
		${QUIET} && QUIET="false" ${FUNCNAME} marker
	elif [[ ${1} == "usage" ]]; then
		declare PRINTF=
		PRINTF+="${TITLE}%-45.45s${RESET}"
		PRINTF+=" ${STATE}%-15.15s${RESET}"
		PRINTF+=" ${HOWTO}%s${RESET}"
		PRINTF+=" ${STATE}%s${RESET}\n"
		echo -en "\n"
		echo -en "${NOTES}"
		echo -en ">>> USAGE <<<"
		echo -en "${RESET}\n"
		echo -en "${STATE}"
		echo -en ">>> ARGUMENT PROCESSING IS VERY RUDIMENTARY // OPTIONS MUST BE IN THE ORDER SHOWN <<<"
		echo -en "${RESET}\n"
		echo -en "\n"
		printf "${PRINTF}" "Synchronize (Database, Sources, Metadata):"	"<auto>"	"${_HEART} -U [{branch} {commit_id}]" "<${FUNTOO}>"
		printf "${PRINTF}" "Synchronize (Sources, Metadata):"		"<auto>"	"${_HEART} -U -f"
		printf "${PRINTF}" "Synchronize (Metadata Only):"		"<auto>"	"${_HEART} -!"
		echo -en "\n"
		printf "${PRINTF}" "Reset Current Configuration:"		"<auto>"	"GOSDIR=/ ${_HEART} -g -r -!"
		printf "${PRINTF}" "Update Current System:"			"<auto>"	"${_HEART}"
		printf "${PRINTF}" "Upgrade Current System:"			"<auto>"	"${_HEART} -a -u"
		printf "${PRINTF}" "Upgrade Current System (Interactively):"	"<interactive>"	"${_HEART} -u"
		echo -en "\n"
		printf "${PRINTF}" "Information Lookup (Package Data):"		"<output>"	"${_HEART} [{chroot}] -l {package}"
		printf "${PRINTF}" "Information Lookup (Package Search):"	"<output>"	"${_HEART} [{chroot}] -l {search}"
		printf "${PRINTF}" "Information Lookup (Gentoo Bug URL):"	"<output>"	"${_HEART} [{chroot}] -l {bug_id}"
		echo -en "\n"
		printf "${PRINTF}" "Build Examination (Review Failures):"	"<output>"	"${_HEART} [{chroot}] -p"
		printf "${PRINTF}" "Build Configuration (Internal Only):"	"<internal>"	"${_HEART} -w"
		printf "${PRINTF}" "Build Configuration Files (Internal Only):"	"<internal>"	"${_HEART} -W"
		echo -en "\n"
		printf "${PRINTF}" "Validation (Usage & Variables Only):"	"<output>"	"${_HEART} ${DEBUG_OPT} [{chroot}] [{options}]"
		printf "${PRINTF}" "Variable Query (Internal Only):"		"<internal>"	"${_HEART} ${DEBUG_OPT} [{chroot}] [{options}] {variable}"
		printf "${PRINTF}" "Suppress Output (Internal Only)"		"<internal>"	"${_HEART} [${DEBUG_OPT}] ${QUIET_OPT} [{chroot}] [{options}]"
		echo -en "\n"
		printf "${PRINTF}" "Run Script (Configuration):"		"<custom>"	"${_HEART} {script} [{options}]" "<$(basename ${CFGSCR}) [${_OPTS}]>"
		echo -en "\n"
		echo -en "${NOTES}"
		echo -en ">>> CHROOT <<<"
		echo -en "${RESET}\n"
		echo -en "${STATE}"
		echo -en ">>> TARGET=\$*DIR _PKG=\$*PKG <<<"
		echo -en "${RESET}\n"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Selection [-d] (\$BLDPKG/\$BLDDIR):"	"${BLDPKG}"	"${BLDDIR}"
		printf "${PRINTF}" "Chroot Selection [-x] (\$WRKPKG/\$WRKDIR):"	"${WRKPKG}"	"${WRKDIR}"
		printf "${PRINTF}" "Chroot Selection [-g] (\$GOSPKG/\$GOSDIR):"	"${GOSPKG}"	"${GOSDIR}"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Build (Initial):"			"<auto>"	"${_HEART} {chroot} -0" "<-n -a -b -k -i>"
		printf "${PRINTF}" "Chroot Build (Update Only):"		"<auto>"	"${_HEART} {chroot} -/" "<-a -i>"
		printf "${PRINTF}" "Chroot Build (Complete Rebuild):"		"<auto>"	"${_HEART} {chroot} -1" "<-a -b -k -i>"
		printf "${PRINTF}" "Chroot Build (Configuration):"		"<custom>"	"${_HEART} {chroot} -2" "<-c -i>"
		printf "${PRINTF}" "Chroot Build (Internal Only):"		"<internal>"	"${_HEART} {chroot} [-m|-n|-a|-b|-k|-c] -i"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Validation (Dependency Tree):"	"<output>"	"${_HEART} [{chroot}] -y -j"
		printf "${PRINTF}" "Chroot Validation (Reverse Dependencies):"	"<output>"	"${_HEART} [{chroot}] -y -j (d|depends) {package}"
		printf "${PRINTF}" "Chroot Validation (Equery Wrapper):"	"<output>"	"${_HEART} [{chroot}] -y -j (-h|{options})"
		printf "${PRINTF}" "Chroot Validation (Change Review):"		"<output>"	"${_HEART} {chroot} -y [{packages_file}]"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Configuration (Overlay Helper):"	"<interactive>"	"${_HEART} {chroot} -o {package}"
		printf "${PRINTF}" "Chroot Configuration (Overlay Downloader):"	"<interactive>"	"${_HEART}          -o {package} {file} [{commit}]"
		printf "${PRINTF}" "Chroot Configuration (Internal Only):"	"<internal>"	"${_HEART} {chroot} -r [-w]"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Shell (Bash):"			"<interactive>"	"${_HEART} {chroot} -s"
		printf "${PRINTF}" "Chroot Shell (Run Command):"		"<auto>"	"${_HEART} {chroot} -s \"{command}\""
		echo -en "\n"
		printf "${PRINTF}" "Chroot Emerge Command:"			"<auto>"	"${_HEART} {chroot} -a -s -e {command}"
		printf "${PRINTF}" "Chroot Emerge Command (Interactively):"	"<interactive>"	"${_HEART} {chroot} -s -e {command}"
		echo -en "\n"
		printf "${PRINTF}" "Chroot Complete (Unmount Cleanup):"		"<auto>"	"${_HEART} {chroot} -z"
		echo -en "\n"
		echo -en "${NOTES}"
		echo -en ">>> INITRAMFS <<<"
		echo -en "${RESET}\n"
		#note: these need to match the names in the "${MAKEIT}" script
		echo -en "\n"
		printf "${PRINTF}" "Initramfs Build (Chroot Reset):"		"<auto>"	"${_HEART} {chroot} ${MAKEIT}_reset"
		printf "${PRINTF}" "Initramfs Build (Chroot Create):"		"<auto>"	"${_HEART} {chroot} ${MAKEIT}_build"
		printf "${PRINTF}" "Initramfs Build (Chroot Root):"		"<auto>"	"${_HEART} {chroot} ${MAKEIT}_rootfs"
		printf "${PRINTF}" "Initramfs Build (Chroot Fetch):"		"<auto>"	"${_HEART} {chroot} ${MAKEIT}_fetch"
		echo -en "\n"
		printf "${PRINTF}" "Initramfs System (Live Reset):"		"<auto>"	"(BLD|WRK|GOS)DIR=/ ${_HEART} {chroot} ${MAKEIT}_reset"
		printf "${PRINTF}" "Initramfs System (Live Create):"		"<auto>"	"(BLD|WRK|GOS)DIR=/ ${_HEART} {chroot} ${MAKEIT}_build"
		printf "${PRINTF}" "Initramfs System (Live Root):"		"<auto>"	"(BLD|WRK|GOS)DIR=/ ${_HEART} {chroot} ${MAKEIT}_rootfs"
		printf "${PRINTF}" "Initramfs System (Live Unpack):"		"<auto>"	"(BLD|WRK|GOS)DIR=/ ${_HEART} {chroot} ${MAKEIT}_unpack"
		printf "${PRINTF}" "Initramfs System (Live Install):"		"<auto>"	"(BLD|WRK|GOS)DIR=/ ${_HEART} {chroot} ${MAKEIT}_install"
		echo -en "\n"
		printf "${PRINTF}" "Distribution Targets (Internal Only):"	"<internal>"	"${_HEART} [{chroot}] ($(		${SED} -n "s|^function[ ](.+)[ ][{].*[#]\{ismain\}.*$|\1|gp"	${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Reset (Internal Only):"	"<internal>"	"${_HEART} [{chroot}] ($(		${SED} -n "s|^function[ ](.+)[ ][{].*[#]\{doredo\}.*$|\1|gp"	${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Reset & Exit (Internal Only):"	"<internal>"	"${_HEART} [{chroot}] ($(		${SED} -n "s|^function[ ](.+)[ ][{].*[#]\{isexit\}.*$|\1|gp"	${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Fast (Internal Only):"		"<internal>"	"${_HEART} [{chroot}] ($(		${SED} -n "s|^function[ ](.+)[ ][{].*[#]\{dofast\}.*$|\1|gp"	${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Test (Internal Only):"		"<internal>"	"${_HEART} [{chroot}] ($(		${SED} -n "s|^function[ ](.+)[ ][{].*[#]\{dotest\}.*$|\1|gp"	${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		echo -en "\n"
		printf "${PRINTF}" "Distribution Prepare (Internal Only):"	"<internal>"	"${_HEART} {chroot} ${PREPIT}_($(	${SED} -n "s|^function[ ]${PREPIT}_(.+)[ ][{].*$|\1|gp"		${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Release (Internal Only):"	"<internal>"	"${_HEART} {chroot} ${MAKEIT}_($(	${SED} -n "s|^function[ ]${MAKEIT}_(.+)[ ][{].*$|\1|gp"		${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		printf "${PRINTF}" "Distribution Publish (Internal Only):"	"<internal>"	"${_HEART}          ${SHIPIT}_($(	${SED} -n "s|^function[ ]${SHIPIT}_(.+)[ ][{].*$|\1|gp"		${SETDIR}/${FUNDIR}/${MAKEIT} | tr '\n' '|' | ${SED} "s|[|]*$||g"	))"
		echo -en "\n"
	elif [[ ${1} == "starter" ]]; then
		function starter_var {
			declare COLOR="${HOWTO}"
			declare VAR="${1}"
			if [[ -z ${!VAR} ]]; then
				COLOR="${STATE}"
			fi
			declare PRINTF=
			PRINTF+="${TITLE}%-15.15s${RESET} "
			PRINTF+="${COLOR}%s${RESET}\n"
			printf "${PRINTF}" "${VAR}:" "${!VAR:-(unset)}"
		}
		echo -en "\n"
		echo -en "${NOTES}"
		echo -en ">>> GLOBALS <<<"
		echo -en "${RESET}\n"
		echo -en "\n"
		starter_var "_SOUL"
		if [[ ${_SOUL} != ${_SELF} ]]; then starter_var "_SELF"; fi
		starter_var "_OPTS"
		starter_var "DEBUG"; #>>> starter_var "DEBUG_OPT"
		starter_var "QUIET"; #>>> starter_var "QUIET_OPT"
		echo -en "\n"
		declare BEG="true"
		for FILE in SETTINGS OPTIONS VARIABLES; do
			if ${BEG}; then BEG="false"; else echo -en "\n"; fi
			echo -en "${NOTES}"
			echo -en ">>> ${FILE} <<<"
			echo -en "${RESET}\n"
			if [[ ${FILE} == OPTIONS ]]; then
				echo -en "${STATE}"
				echo -en ">>> THESE CAN BE CHANGED <<<"
				echo -en "${RESET}\n"
			fi
			echo -en "\n"
			declare END="true"
			${SED} -n "s|^[#]${FILE}[[](.+)[]]$|\1|gp" ${_SOUL} | while read -r NEXT; do
				if ${END}; then END="false"; else echo -en "\n"; fi
				for FILE in ${NEXT}; do
					starter_var "${FILE}"
				done
			done
		done
		echo -en "\n"
	elif [[ ${1} == "environment" ]]; then
		echo -en "${NOTES}"
		echo -en "Clearing Environment Variables..."
		echo -en "${RESET}\n"
	elif [[ ${1} == "update" ]]; then
		echo -en "${NOTES}"
		echo -en "Preparing To Update All Data"
		for FILE in {1..10}; do
			echo -en "."
			sleep 1
		done
		echo -en "${RESET}\n"
	elif [[ ${1} == "mount" ]]; then
		echo -en "${NOTES}"
		echo -en "Mounting Chroot Directories..."
		echo -en "${RESET}\n"
	elif [[ ${1} == "umount" ]]; then
		echo -en "${NOTES}"
		echo -en "Unmounting Chroot Directories..."
		echo -en "${RESET}\n"
	else
		echo -en "${ERROR}"
		echo -en ">>> SOMEBODY MADE A MISTAKE! <<<"
		echo -en "${RESET}\n"
	fi
	return 0
}

########################################

function requires_chroot {
	declare SRC_OPTS="${@}"
	declare C_OPTION="${1}" && shift
	declare C_TARGET="${TARGET}"
	if [[ -z ${TARGET} ]]; then
		C_TARGET="/"
	fi
	echo -en "\n"
	echo -en ">>> THIS OPTION (${SRC_OPTS}) REQUIRES A CHROOT <<<\n"
	echo -en ">>> IT CAN BE RUN AGAINST ROOT(/) USING THE (-g)(GOSDIR=/) OPTIONS <<<\n"
	echo -en ">>> CURRENTLY USING (${TOOR}) CHROOT OPTION AND (${C_TARGET}) DIRECTORY <<<\n"
	echo -en "\n"
	${_SOUL} ${DEBUG_OPT} ${QUIET_OPT} 2>&1 | ${GREP} " ${C_OPTION}"
	echo -en "\n"
	EXIT 1
}

########################################

function expect_wrapper {
	declare EXPECT_CMD="spawn -noecho $(
		for FILE in "${@}"; do
			if [[ -n $(echo "${FILE}" | ${GREP} " ") ]]; then
				echo " \\\"${FILE}\\\""
			else
				echo "${FILE}"
			fi
		done
	);"
	EXPECT_CMD+=" "; EXPECT_CMD+="set timeout -1;"
	EXPECT_CMD+="";
	EXPECT_CMD+=" "; EXPECT_CMD+="expect"
	EXPECT_CMD+=" "; EXPECT_CMD+="-nocase yes*/*no*	{send y\\\\r; exp_continue;}"
	EXPECT_CMD+=" "; EXPECT_CMD+="-nocase use-new*	{send u\\\\r; exp_continue;}"
	EXPECT_CMD+=" "; EXPECT_CMD+="default {}"
	EXPECT_CMD+=" "; EXPECT_CMD+="eof"
	EXPECT_CMD+=" "; EXPECT_CMD+=";"
	EXPECT_CMD+="";
	EXPECT_CMD+=" "; EXPECT_CMD+="lassign [wait] pid spawnid os_error exit_status;"
	EXPECT_CMD+=" "; EXPECT_CMD+="if {(\\\$os_error == 0) && (\\\$exit_status == 0)} { exit 0; } else { exit 1; };"
	if [[ -n ${AUTO} ]] && {
		{ ${DO_CHROOT}		&& [[ -x "${TARGET}/usr/bin/expect" ]]; } ||
		{ ! ${DO_CHROOT}	&& [[ -x "/usr/bin/expect" ]]; }
	}; then
		eval safe_env expect -c \"${EXPECT_CMD}\"	|| return 1
	else
		safe_env "${@}"					|| return 1
	fi
	return 0
}

########################################

function mount_dev_dirs {
	if ! ${DO_CHROOT} || [[ ! -d ${TARGET} ]] || [[ -z ${TARGET} ]]; then
		return 0
	fi
	if [[ -z ${1} ]]; then
		print_info marker
		print_info mount
		if ! mount-robust --dev ${TARGET}		2>&1 |
			if ${QUIET}; then prompt -t; else cat; fi
		then						return 1; fi
		print_info marker
	elif [[ ${1} == -u ]]; then
		shift
		print_info marker
		print_info umount
		safe_env killall --verbose -9 gpg-agent 2>&1 |
			if ${QUIET}; then prompt -t; else cat; fi
		declare LSOF="$(
			lsof |
			${GREP} "${TARGET}" |
			${GREP} -v "${TARGET}${GENDIR}.log$"
		)"
		if [[ -n ${LSOF} ]]; then
			echo -en "\n"
			echo -en ">>> THERE ARE STILL PROCESSES IN THE CHROOT <<<\n"
			echo -en ">>> SKIPPING UNMOUNT <<<\n"
			echo -en "\n"
			echo "${LSOF}" | ${GREP} "${TARGET}" 2>&1 #>>> |
#>>>				if ${QUIET}; then prompt -t; else cat; fi
#>>>			if ! ${QUIET}; then echo -en "\n"; fi
				echo -en "\n"
#>>>
			mount | ${GREP} "${TARGET}" 2>&1 #>>> |
#>>>				if ${QUIET}; then prompt -t; else cat; fi
#>>>			if ! ${QUIET}; then echo -en "\n"; fi
				echo -en "\n"
#>>>
			print_info marker
			EXIT -1 #>>> return 1
		else
			if ! mount-robust -u --dev ${TARGET}	2>&1 |
				if ${QUIET}; then prompt -t; else cat; fi
			then					return 1; fi
		fi
		print_info marker
	fi
	return 0
}

########################################

function kernel_cpu {
	declare CFG_FILE="${1}" && shift
	if [[ ${_CPU_RESET} != ${_CPU} ]]; then
		${SED} -i \
			-e "/${_CPU_RESET}/d" \
			-e "s/^.*(${_CPU})[^_].*$/\1=y/g" \
			${CFG_FILE} \
			|| return 1
	fi
	return 0
}

########################################

function delete_empty {
	declare TGT_DIR="${1}" && shift
	declare TGT_TYP="-type d"
	if [[ ${1} == -a ]]; then
		TGT_TYP=
		shift
	fi
	FILE="$(find ${TGT_DIR} -mindepth 1 ${TGT_TYP} -empty)"
	while [[ -n ${FILE} ]]; do
		${RM} ${FILE} || return 1
		FILE="$(find ${TGT_DIR} -mindepth 1 ${TGT_TYP} -empty)"
	done
	return 0
}

################################################################################

trap "EXIT 1" SIGHUP SIGINT SIGKILL SIGTERM

function EXIT {
	declare EXIT="0"
	if [[ ${1} != 0 ]] && [[ ${1} != -0 ]]; then
		if [[ ${1} == -1 ]]; then
			EXIT="1" && shift
		else
			EXIT="${1}" && shift
			mount_dev_dirs -u || EXIT -1
		fi
		print_info marker
		print_info error
		print_info marker
	else
		if [[ ${1} == -0 ]]; then
			EXIT="0" && shift
		fi
		print_info marker
		print_info success
		print_info marker
	fi
	exit ${EXIT}
}

########################################

source ${SETDIR}/${FUNDIR}/${MAKEIT} || EXIT 1

########################################

#NOTE: ALL "^if.*{1}" OPTIONS UP TO THIS POINT NEED TO BE "$_BASH_SOURCED" PROTECTED

if ${_BASH_SOURCED}; then
	return 0
fi

########################################

if ${DEBUG} && [[ ${1} == +([A-Z]) ]]; then
	FILE="${1}" && shift
	echo "${!FILE}"
	exit 0
fi

declare DEBUG_QUIET="${QUIET}"
if ${DEBUG}; then
	QUIET="false"
fi
print_info marker;		print_info title
print_info marker;		print_info usage
if [[ -z ${_OPTS} ]]; then
	EXIT 0
fi
print_info marker;		print_info starter
if ! ${DEBUG}; then
	print_info marker;	print_info environment;
	clear_environment
	print_info marker
fi

if ${DEBUG}; then
	if ${DO_CHROOT} && ! ${DEBUG_QUIET}; then
		if [[ ! -d ${TARGET} ]] || [[ ! -x ${TARGET}${MYSELF} ]]; then
			echo -en "\n"
			${LL} ${TARGET}${MYSELF}
			requires_chroot "${@}"
		fi
		set -x
		safe_env ${MYSELF} ${DEBUG_OPT} ${TOOR} "${@}" || EXIT 1
		set +x
	fi
	EXIT 0
fi

################################################################################

if ${DO_CHROOT} && [[ -n ${TARGET} ]] && [[ ! -d ${TARGET} ]]; then
	echo -en "\n"
	${LL} -d ${TARGET}
	requires_chroot "${@}"
fi

########################################

if
[[ ${1} == ${PREPIT}+(*) ]] ||
[[ ${1} == ${MAKEIT}+(*) ]] ||
[[ ${1} == ${SHIPIT}+(*) ]]
then
	if ! ${DO_CHROOT}; then
		requires_chroot "${@}"
	fi
	mount_dev_dirs -u	|| EXIT 1
	declare DOIT="${1}"	&& shift
	${DOIT} "${@}"		|| EXIT -1
	EXIT -0
fi

########################################

if [[ -x ${1} ]]; then
	declare DOIT="${1}"	&& shift
	${DOIT} ${_SOUL} "${@}"	|| EXIT -1
	EXIT -0
fi

################################################################################

if [[ ${1} == -z ]]; then
	if ! ${DO_CHROOT}; then
		requires_chroot "${@}"
	fi
	shift
	mount_dev_dirs -u || EXIT 1
	EXIT 0
fi

########################################

if [[ ${1} == -s ]]; then
	if ! ${DO_CHROOT}; then
		requires_chroot "${@}"
	fi
	shift
	mount_dev_dirs					|| EXIT 1
	if [[ ${1} == -e ]]; then
		shift
		#note: ensuring configuration is up-to-date
		if ! ${_SOUL} ${QUIET_OPT} ${TOOR} -r	2>&1 |
			if ${QUIET}; then prompt -t; else cat; fi
		then					EXIT 1; fi
		expect_wrapper emerge ${_ASK}		\
			${EMERGE_TREE_OPTS}		\
			${EMERGE_UPDT_OPTS}		\
			--selective=n			\
			--usepkg=n			\
			--getbinpkg=n			\
			${@:-\@system \@world}		2>&1 | prompt -c
		[[ ${PIPESTATUS[0]} == 0 ]]		|| EXIT 1
	else
		safe_env bash --norc ${@:+-c "${@}"}	|| EXIT 1
	fi
	mount_dev_dirs -u				|| EXIT 1
	EXIT 0
fi

########################################

if [[ ${1} == -y ]]; then
	if ! ${DO_CHROOT} && [[ ${2} != -j ]]; then
		requires_chroot "${@}"
	fi
	shift
	if ${DO_CHROOT}; then
		#note: ensuring configuration is up-to-date
		if ! ${_SOUL} ${QUIET_OPT} ${TOOR} -r	2>&1 |
			if ${QUIET}; then prompt -t; else cat; fi
		then					EXIT 1; fi
	fi
	if [[ ${1} == -j ]]; then
		shift
		mount_dev_dirs				|| EXIT 1
		if [[ ${1} == depends ]] || [[ ${1} == d ]]; then
			shift
			safe_env equery depends		\
				--indirect		\
				--depth=0		\
				"${@}"			|| EXIT 1
		elif [[ -n ${1} ]]; then
			safe_env equery			\
				"${@}"			|| EXIT 1
		else
			safe_env emerge ${_ASK}		\
				${EMERGE_TREE_OPTS}	\
				--pretend		\
				--emptytree		\
				\@system \@world	|| EXIT 1
		fi
		mount_dev_dirs -u			|| EXIT 1
		EXIT 0
	fi
	#note: the "_packages" file is hard-set in the ".emergent" script
	FILE="${_SAVDIR}${GENDIR}/_packages"
	if [[ ! -f ${1} ]]; then
		echo -en "\n"
		echo -en ">>> YOU ALMOST CERTAINLY WANT TO SPECIFY YOUR OWN PACKAGES FILE TO COMPARE AGAINST <<<\n"
		echo -en ">>> THIS OPTION IS READ-ONLY SO THERE IS NO POTENTIAL FOR HARM <<<\n"
#>>>		echo -en "\n"
	else
		FILE="${1}"
		shift
	fi
	if [[ ! -f ${FILE} ]] || [[ ! -f ${TARGET}${GENDIR}/_packages ]]; then
		echo -en "\n"
		echo -en ">>> ONE OF (${FILE}) OR (${TARGET}${GENDIR}/_packages) DOES NOT EXIST <<<\n"
		echo -en ">>> VALID SOURCE ({packages_file}) AND DESTINATION (-g)(GOSDIR=/) FILES ARE REQUIRED <<<\n"
		echo -en ">>> SKIPPING PACKAGE COMPARISONS <<<\n"
#>>>		echo -en "\n"
#>>>		EXIT 1
	else
		function compare_packages {
			declare NAM="${1}" && shift
			declare SRC="${1}" && shift
			declare DST="${1}" && shift
			echo -en "\n"
			echo -en ">>> PACKAGES: ${NAM} <<<\n"
			echo -en ">>> COMPARING (${DST}) AGAINST (${SRC}) FILE <<<\n"
			echo -en "\n"
			for NEXT in $(cat ${DST}); do
				NEXT="$(echo "${NEXT}" | ${SED} "s|[-][0-9].*$||g")"
				if [[ -z $(${GREP} "${NEXT}" ${SRC}) ]]; then
					${GREP} "${NEXT}" ${DST}
				fi
			done
			return 0
		}
		compare_packages "ADDED"	${FILE}				${TARGET}${GENDIR}/_packages
		compare_packages "REMOVED"	${TARGET}${GENDIR}/_packages	${FILE}
	fi
	#note: the ".emerge" file is hard-set in the ".emergent" script
	echo -en "\n>>> USE: GLOBAL <<<\n"
	for FILE in $(
		source ${SETDIR}/${FUNDIR}/make.conf
		echo -en "${USE_GARYOS}"
	); do
		echo -en "\n"
		${GREP} "${FILE/#-}" ${SETDIR}/${FUNDIR}/make.conf
		${GREP} "${FILE/#-}" ${TARGET}${GENDIR}/.emerge
	done
	echo -en "\n>>> USE: PACKAGES <<<\n"
	for FILE in $(
		${SED} -n "s|^[#][{]GOS[}][ ]([^[:space:]]+).*$|\1|gp" ${SETDIR}/${FUNDIR}/package.use
	); do
		echo -en "\n"
		${GREP} "${FILE}" ${SETDIR}/${FUNDIR}/package.use
		${GREP} "${FILE}" ${TARGET}${GENDIR}/.emerge
	done
	echo -en "\n>>> ESELECT <<<\n"
	echo -en "\n"
	for FILE in \
		kernel:kernel \
		python:python \
		${SELECT}
	do
		declare KEY="$(echo "${FILE}" | ${SED} "s|^(.+)[:](.+)$|\1|g")"
		eselect ${KEY} list
	done
	EXIT 0
fi

########################################

if [[ ${1} == -o ]]; then
	if ! ${DO_CHROOT} && ! ${IS_CHROOT} && [[ -z ${3} ]]; then
		requires_chroot "${@}"
	fi
#>>>	shift
	if ${DO_CHROOT} || [[ -n ${3} ]]
		then FILE="${SETDIR}/${FUNDIR}"
		else FILE="${ETCDIR}"
	fi
	declare FILES=($(${LS} --directory \
		${FILE}/${LAYDIR}/${2} \
		${FILE}/${LAYDIR}/*/${2} \
		2>/dev/null
	))
	if (( ${#FILES[*]} == 1 )); then
		FILE="${FILES[0]/#${FILE}\/${LAYDIR}\/}"
	elif (( ${#FILES[*]} < 1 )); then
		echo -en "\n"
		echo -en ">>> NO MATCHES <<<\n"
		echo -en "\n"
		${LL} -d \
			${FILE}/${LAYDIR}/${2} \
			${FILE}/${LAYDIR}/*/${2}
		EXIT 1
	elif (( ${#FILES[*]} > 1 )); then
		echo -en "\n"
		echo -en ">>> TOO MANY MATCHES <<<\n"
		echo -en "\n"
		${LL} -d \
			${FILE}/${LAYDIR}/${2} \
			${FILE}/${LAYDIR}/*/${2} \
			2>/dev/null
		EXIT 1
	fi
	if [[ -n ${3} ]]; then
		declare BASE="https://gitweb.gentoo.org/repo/gentoo.git"
		declare OFIL="${3}"; if [[ -z $(echo "${OFIL}" | ${GREP} "[.]ebuild$") ]]; then OFIL="files/${OFIL}"; fi
		declare ID="$(if [[ -n ${4} ]]; then echo "?id=${4}"; fi)"
		declare FAIL=
		declare SKIP=
		echo "-- ${3} -- ${BASE}/tree/${FILE}${ID}"	>>${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/.rationale		|| EXIT 1
		${MKDIR}					${SETDIR}/${FUNDIR}/${LAYDIR}/$(dirname ${FILE}/${OFIL})	|| EXIT 1
		${WGET_C} -O					${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/${OFIL}			\
								"${BASE}/plain/${FILE}/${OFIL}${ID}"				|| FAIL+=" ${OFIL}" #>>> EXIT 1
		for NEXT in $(${SED} -n				"s|^.*[\"]?[$][{]FILESDIR[}][\"]?/([^[:space:]\"]+).*$|\1|gp"	\
								${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/${OFIL}			2>/dev/null
		); do
			declare PN="$(basename ${2})"
			declare PV="$(echo "${OFIL}" | ${SED} -e "s|^${PN}[-](.+)[.]ebuild$|\1|g" -e "s|[-]r[0-9]+$||g")"
			NEXT="${NEXT/%)}"
			NEXT="$(echo "${NEXT}" | ${SED} "s|[$][{]P[}]|${PN}-${PV}|g")"
			NEXT="$(echo "${NEXT}" | ${SED} "s|[$][{]PN[}]|${PN}|g")"
			NEXT="$(echo "${NEXT}" | ${SED} "s|[$][{]PV[}]|${PV}|g")"
			if [[ -n $(echo "${NEXT}" | ${GREP} "[$]") ]]; then SKIP+=" ${NEXT}"; continue; fi
			${MKDIR}				${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/files			|| EXIT 1
			${WGET_C} -O				${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/files/${NEXT}		\
								"${BASE}/plain/${FILE}/files/${NEXT}${ID}"			|| FAIL+=" ${NEXT}" #>>> EXIT 1
		done
		if [[ -n ${FAIL} ]] || [[ -n ${SKIP} ]]; then
			echo -en "\n"
			if [[ -n ${FAIL} ]]; then
				echo -en ">>> THESE FILES WERE NOT DOWNLOADED SUCCESSFULLY: ${FAIL/# } <<<\n"
			fi
			if [[ -n ${SKIP} ]]; then
				echo -en ">>> THESE FILES WERE SKIPPED: ${SKIP/# } <<<\n"
			fi
			echo -en "\n"
		elif ${DO_CHROOT}; then
			${_SOUL} $(if ${QUIET}; then echo "${QUIET_OPT}"; fi) ${TOOR} ${1} ${2}					|| EXIT 1
		fi
		echo -en ">>> ${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/.rationale <<<\n"
		cat ${SETDIR}/${FUNDIR}/${LAYDIR}/${FILE}/.rationale
		if [[ -n ${FAIL} ]] || [[ -n ${SKIP} ]]; then
			EXIT 1
		fi
		EXIT 0
	fi
	if ${DO_CHROOT}; then
		mount_dev_dirs													|| EXIT 1
		declare LAY_DIR="${SETDIR}/${FUNDIR}/${LAYDIR}"
		declare ETC_DIR="${TARGET}${ETCDIR}/${LAYDIR}"
		#note: ensuring configuration is up-to-date
		if ! ${_SOUL} ${QUIET_OPT} ${TOOR} -r										2>&1 |
			if ${QUIET}; then prompt -t; else cat; fi; then								EXIT 1; fi
		${MKDIR}	${ETC_DIR}/${FILE}			${LAY_DIR}/${FILE}/.source				|| EXIT 1
		${RSYNC_U}	${TARGET}${REPDIR}/${FILE}/		${LAY_DIR}/${FILE}/.source				||
		touch							${LAY_DIR}/${FILE}/.source/.null			|| EXIT 1
		${RSYNC_U}	${LAY_DIR}/${FILE}/			${ETC_DIR}/${FILE}					|| EXIT 1
		safe_env ${MYSELF} ${QUIET_OPT} ${TOOR} "${@}"									|| EXIT 1
		${RSYNC_U}	${ETC_DIR}/${FILE}/Manifest		${LAY_DIR}/${FILE}/					|| EXIT 1
		${RSYNC_U}	${ETC_DIR}/.review.txt			${LAY_DIR}/						|| EXIT 1
		mount_dev_dirs -u												|| EXIT 1
	else
		FILE="$(realpath ${ETCDIR}/${LAYDIR}/${FILE}/*.ebuild | sort -n | tail -n1)"
		ebuild		${FILE} digest											|| EXIT 1
		(cd		${ETCDIR}/${LAYDIR} && ./.review)								|| EXIT 1
	fi
	EXIT 0
fi

########################################

if [[ ${1} == -l ]]; then
#>>>	shift
	if ${DO_CHROOT}; then
		safe_env ${MYSELF} ${QUIET_OPT} ${TOOR} "${@}" || EXIT 1
		EXIT 0
	fi
	shift
	if [[ -z ${1} ]]; then
		EXIT 0
	elif [[ ${1} == +([0-9]) ]]; then
		echo -en "https://bugs.gentoo.org/show_bug.cgi?id=${1}\n"
	else
		FILE="$(${LS} -d ${REPDIR}/*/${1} 2>/dev/null)"
		NEXT="$(echo "${FILE}" | ${SED} "s|^${REPDIR}/.+[/]([^/]+[/][^/]+)$|\1|g")"
		if [[ -z ${FILE} ]]; then
			mount_dev_dirs		|| EXIT 1
			safe_env emerge --search "${@}"
			mount_dev_dirs -u	|| EXIT 1
		else
			echo -en "https://packages.gentoo.org/packages/${NEXT}\n"
			echo -en "https://gitweb.gentoo.org/repo/gentoo.git/log/${NEXT}\n"
			echo -en "https://gentoobrowse.randomdan.homeip.net/package/${NEXT}#bugs\n"
			${LL} -d ${DSTDIR}/$(basename ${FILE})*
			${LL} -d ${PAKDIR}/${NEXT}*
			${LL} -d ${TMPDIR}/${NEXT}-[0-9]*/temp/build.log
			echo -en "${FILE}\n"
			${LL} ${FILE}
		fi
	fi
	EXIT 0
fi

########################################

#{CMD} for FILE in ${FILELIST}; do less ./build${FILE} ; read continue ; done

if [[ ${1} == -p ]]; then
#>>>	shift
	if ${DO_CHROOT}; then
		safe_env ${MYSELF} ${QUIET_OPT} ${TOOR} "${@}" || EXIT 1
		EXIT 0
	fi
	shift
	${RM} ${TMPDIR}/._portage_reinstall_.*
	delete_empty ${TMPDIR} -a
	${LL} -d ${TMPDIR}
	${LL} ${TMPDIR}
	FILE="$(find ${TMPDIR}/[a-z]* -mindepth 1 -maxdepth 1 2>/dev/null | sort --unique)"
	if [[ -n ${FILE} ]]; then
		echo -en "\n"
		${LL} -d ${FILE}
		for NEXT in ${FILE}; do
			NEXT="$(basename ${NEXT} | ${SED} "s|[-][0-9][^/]+$||g")"
			echo -en "\n>>> ${NEXT} <<<\n"		1>&2
			safe_env ${_SOUL} ${QUIET_OPT} -l ${NEXT}
		done
		echo -en "\n"					1>&2
		echo -en "FILELIST=\""				1>&2
		for NEXT in ${FILE}; do
			echo -en "${NEXT}/temp/build.log "
		done |
			${SED} "s|[ ]*$||g"			1>&2
		echo -en "\"\n"					1>&2
		EXIT 1
	fi
	EXIT 0
fi

################################################################################

if [[ ${1} == -[0/12] ]]; then
	${MKDIR} $(dirname ${TARGET}${GENDIR})
	date --iso=seconds >${TARGET}${GENDIR}.log 2>&1
fi

if [[ ${1} == -0 ]]; then shift; ${_SOUL} ${TOOR} -n -a -b -k	-i 2>&1 | tee --append ${TARGET}${GENDIR}.log | prompt -c	; exit ${PIPESTATUS[0]}; fi
if [[ ${1} == -/ ]]; then shift; ${_SOUL} ${TOOR} -a		-i 2>&1 | tee --append ${TARGET}${GENDIR}.log | prompt -c	; exit ${PIPESTATUS[0]}; fi
if [[ ${1} == -1 ]]; then shift; ${_SOUL} ${TOOR} -a -b -k	-i 2>&1 | tee --append ${TARGET}${GENDIR}.log | prompt -c	; exit ${PIPESTATUS[0]}; fi
if [[ ${1} == -2 ]]; then shift; ${_SOUL} ${TOOR} -c		-i								; exit ${PIPESTATUS[0]}; fi

########################################

if [[ ${1} == -r ]]; then
	if ! ${DO_CHROOT}; then
		requires_chroot "${@}"
	fi
	shift
	if [[ ${1} != -! ]]; then
		${MKDIR}					${TARGET}${ARCDIR}				|| EXIT 1
	fi
	if [[ -n ${COMMIT} ]]
		#note: also doing this in "${MAKEIT}" script on purpose
		then echo -en "${COMMIT}"			>${TARGET}/${CMTFIL}				|| EXIT 1
		else ${RM}					${TARGET}/${CMTFIL}				|| EXIT 1
	fi
	if [[ ${1} != -! ]]; then
		${RSYNC_U} --copy-links ${SETDIR}/.bashrc	${TARGET}${ARCDIR}/				|| EXIT 1
		${RSYNC_U} ${SETDIR}/${LINDIR}/			${TARGET}${ARCDIR}/${LINDIR}			|| EXIT 1
		${RSYNC_U} ${SETDIR}/${FUNDIR}/			${TARGET}${ARCDIR}/${FUNDIR}			|| EXIT 1
	fi
	${RSYNC_C/--delete --delete-during} --copy-links							\
		--filter="-_/${LAYDIR}"										\
		${SETDIR}/${FUNDIR}/[a-z]*			${TARGET}${ETCDIR}/				|| EXIT 1
	${RSYNC_U} ${SETDIR}/${FUNDIR}/${LAYDIR}/		${TARGET}${ETCDIR}/${LAYDIR}			|| EXIT 1
	${MKDIR}						${TARGET}${ETCDIR}/repos.conf			|| EXIT 1
	${LN} ../${LAYDIR}/overlay.conf				${TARGET}${ETCDIR}/repos.conf/			|| EXIT 1
	if [[ ${1} != -! ]]; then
		portage_file					${TARGET}${ARCDIR}/${FUNDIR}			|| EXIT 1
		if [[ ${1} == -w ]]; then
			shift
			safe_env				${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -w	|| EXIT 1
		else
			safe_env				${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -W	|| EXIT 1
		fi
	fi
	EXIT 0
fi

########################################

if [[ ${1} == -i ]]; then
	if ! ${DO_CHROOT}; then
		requires_chroot "${@}"
	fi
#>>>	shift
	if [[ ! -d ${TARGET}/boot ]]; then
		if [[ ! -d ${SOURCE} ]]; then
			echo -en "\n"
			${LL} -d ${SOURCE}
			requires_chroot "${@}"
		fi
		${MKDIR}				${TARGET}${ARCDIR}					|| EXIT 1
		${RSYNC_U} ${SOURCE}/stage3-*		${TARGET}${ARCDIR}/					|| EXIT 1
		FILE="$(basename $(ls			${TARGET}${ARCDIR}/stage3-${STAGE}-*.tar.xz		| tail -n1))"
		if [[ ${FILE} != stage3-${ESUB}.tar.xz ]]; then
			${LN} ${FILE}			${TARGET}${ARCDIR}/stage3-${ESUB}.tar.xz		|| EXIT 1
		fi
		tar --numeric-owner --xattrs --xattrs-include='*.*' --xz -pvvx -C ${TARGET} -f \
							${TARGET}${ARCDIR}/stage3-${ESUB}.tar.xz		|| EXIT 1
	fi
	shift
	mount_dev_dirs												|| EXIT 1
	if ! ${_CFG}; then
		if ${_BLD}; then
			${RM}				${TARGET}${ETCDIR}/savedconfig				|| EXIT 1
		fi
							${_SOUL} ${QUIET_OPT} ${TOOR} ${AUTO} -r		|| EXIT 1
	fi
	if ${_BLD} && ! ${DOFAST}; then
		#note: this needs to match the name in the "${MAKEIT}" script
		${PREPIT}_repdir										|| EXIT 1
	fi
	if ! ${DOFAST} && ! ${_CFG}; then
		safe_env				${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -w		|| EXIT 1
	fi
	if [[ -z "$(which expect 2>/dev/null)" ]]; then
		expect_wrapper				emerge ${_ASK} dev-tcltk/expect				|| EXIT 1
	fi
	if ${_KRN} && ! ${DOFAST}; then
		${RM}					${TARGET}/boot/{_,System.map,vmlinuz,initramfs,config}*	|| EXIT 1
		${RM}					${TARGET}/etc/kernels/*					|| EXIT 1
		${RM}					${TARGET}/lib/modules/*					|| EXIT 1
		${RM}					${TARGET}${LDIR}*					|| EXIT 1
		expect_wrapper				emerge ${_ASK} sys-kernel/genkernel ${LINPKG}		|| EXIT 1
		declare KERN="$(cd ${TARGET}/boot; ls vmlinuz-*-gentoo*		2>/dev/null | sort | tail -n1)"
		declare INIT="$(cd ${TARGET}/boot; ls initramfs-*-gentoo*	2>/dev/null | sort | tail -n1)"
		${RM}					${TARGET}/boot/_kernel					|| EXIT 1
		${RM}					${TARGET}/boot/_initrd					|| EXIT 1
		if [[ -n ${KERN} ]]; then ${LN} ${KERN}	${TARGET}/boot/_kernel					|| EXIT 1; fi
		if [[ -n ${INIT} ]]; then ${LN} ${INIT}	${TARGET}/boot/_initrd					|| EXIT 1; fi
		if [[ -n ${KERN} ]]; then
			KERN="${KERN/#vmlinuz/linux}"
			${RM}				${TARGET}${LDIR}					|| EXIT 1
			${LN} ${KERN}			${TARGET}${LDIR}					|| EXIT 1
		fi
	fi
	if ${_KRN} && ! ${DOFAST}; then for FILE in ${KERNEL}; do
		KSRC="${KBAS//${KVER}/${FILE}}"
		KERN="${KCFG//${KVER}/${FILE}}"
		${RM}					${TARGET}${LDIR}					|| EXIT 1
		${LN} ${KSRC}				${TARGET}${LDIR}					|| EXIT 1
		${RSYNC_U} --copy-links			${SETDIR}/${LINDIR}/${KERN}				\
							${TARGET}${ARCDIR}/${KERN}				|| EXIT 1
		kernel_cpu				${TARGET}${ARCDIR}/${KERN}				|| EXIT 1
		declare GENKERNEL_OPTS="--loglevel=5 --bootloader=grub --install --symlink --luks --zfs"
		if [[ -z ${AUTO} ]]; then
			expect_wrapper			genkernel ${GENKERNEL_OPTS} kernel --menuconfig		|| EXIT 1
		else
			expect_wrapper			genkernel ${GENKERNEL_OPTS} kernel			\
							--kernel-config=${ARCDIR}/${KERN}			|| EXIT 1
		fi
		${RSYNC_U} --copy-links			${TARGET}${LDIR}/.config				\
							${TARGET}${ARCDIR}/${KERN}				|| EXIT 1
		if ! ${_GOS}; then
			KERN="vmlinuz-${FILE}-gentoo-x86_64"
			${RM}				${TARGET}/boot/_cur					|| EXIT 1
			${LN} ${KERN}			${TARGET}/boot/_cur					|| EXIT 1
			${RM}				${TARGET}/boot/_new					|| EXIT 1
			${LN} kernel			${TARGET}/boot/_new					|| EXIT 1
			${RM}				${TARGET}/boot/_old					|| EXIT 1
			${LN} kernel.old		${TARGET}/boot/_old					|| EXIT 1
			[[ -L				${TARGET}/boot/kernel.old				]] ||
			${LN} ${KERN}			${TARGET}/boot/kernel.old				|| EXIT 1
		fi
	done; fi
	if ${_GOS}; then
		${RM}					${TARGET}/boot/_kernel					|| EXIT 1
		${RM}					${TARGET}/boot/_initrd					|| EXIT 1
		${RM}					${TARGET}/boot/_cur					|| EXIT 1
		${RM}					${TARGET}/boot/_new					|| EXIT 1
		${RM}					${TARGET}/boot/_old					|| EXIT 1
	fi
	if ${_CFG}; then
		#note: these need to match the names in the "${MAKEIT}" script
		${MAKEIT}_reset											|| EXIT 1
		if [[ -x ${CFGSCR} ]]; then
			${RSYNC_U} --copy-links		${CFGSCR} \
							${TARGET}${ARCDIR}/$(basename ${CFGSCR})		|| EXIT 1
			safe_env			${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO}			\
							${ARCDIR}/$(basename ${CFGSCR})				|| EXIT 1
		fi
		mount_dev_dirs -u										|| EXIT 1
		EXIT 0
	fi
	if ${_BLD} || ! ${DOFAST}; then
		safe_env				${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -U -f		|| EXIT 1
		if ${_BLD} && ${DOFAST}; then
			echo -en "\n"
			echo -en ">>> READY TO RUN THE BUILD WITHOUT 'DOFAST' ENABLED <<<\n"
			echo -en "\n"
			EXIT 0
		fi
	fi
	if ${_BLD}; then
#>>>		expect_wrapper				emerge ${_ASK} --emptytree \@system \@world		|| EXIT 1
		expect_wrapper				emerge ${_ASK} --emptytree \@system \@${_PKG}		|| EXIT 1
	fi
	safe_env					${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -u		|| EXIT 1
	mount_dev_dirs -u											|| EXIT 1
	EXIT 0
fi

################################################################################

if [[ ${1} == -W ]]; then
	shift
	portage_file		${ETCDIR}	|| EXIT 1
	cat /dev/null		>/var/lib/portage/world
	echo "@${_PKG}"		>/var/lib/portage/world_sets
	$(for NEXT in ${LINPKG}; do
		echo "${NEXT}"	>>/var/lib/portage/world
	done)
	EXIT 0
fi

########################################

if [[ ${1} == -w ]]; then
	shift
	safe_env ${_SOUL} ${QUIET_OPT} ${TOOR} ${AUTO} -W	|| EXIT 1
	if [[ -n "$(which gcc-config 2>/dev/null)" ]]; then
		gcc-config --force $(gcc-config --list-profiles			| ${SED} -n "s|^.*[[][0-9]+[]][[:space:]]+([^[:space:]]+).*$|\1|gp" | sort -uV | tail -n1)
		gcc-config --list-profiles
	fi
	if [[ -n "$(which java-config 2>/dev/null)" ]]; then
		java-config $(java-config --list-available-vm	| ${SED} -n "s|^.*[[](.+)[]].*$|\1|gp" | ${GREP} -o "openjdk[-][0-9]+" | sort -uV | tail -n1)
		java-config --list-available-vms
	fi
	for FILE in \
		binutils \
		gcc \
		java-vm \
		python \
	; do
		if [[ ${FILE} == java-vm ]]; then
			eselect ${FILE} set system $(eselect ${FILE} list	| ${SED} -n "s|^.*[[][0-9]+[]][[:space:]]+([^[:space:]]+).*$|\1|gp" | sort -uV | tail -n1)
		elif [[ ${FILE} == python ]]; then
			eselect ${FILE} set $(eselect ${FILE} list		| ${SED} -n "s|^.*[[][0-9]+[]][[:space:]]+([^[:space:]]+).*$|\1|gp" | ${GREP} "^python" | sort -uV | tail -n1)
		else
			eselect ${FILE} set $(eselect ${FILE} list		| ${SED} -n "s|^.*[[][0-9]+[]][[:space:]]+([^[:space:]]+).*$|\1|gp" | sort -uV | tail -n1)
		fi
		eselect ${FILE} list
	done
	for FILE in \
		kernel:${KBAS} \
		${SELECT} \
	; do
		declare KEY="$(echo "${FILE}" | ${SED} "s|^(.+)[:](.+)$|\1|g")"
		declare VAL="$(echo "${FILE}" | ${SED} "s|^(.+)[:](.+)$|\2|g")"
		if [[ ${KEY} == java-vm ]]; then
			eselect ${KEY} set system ${VAL}
		else
			eselect ${KEY} set ${VAL}
		fi
		eselect ${KEY} list
	done
	ldconfig
	env-update
	locale-gen
	EXIT 0
fi

########################################

if [[ ${1} == -u ]]; then
	shift
	if ! ${DOFAST}; then
		safe_env ${_SOUL} ${QUIET_OPT} ${TOOR} ${AUTO} -w			|| EXIT 1
	fi
	expect_wrapper emerge ${_ASK} ${EMERGE_UPDT_OPTS} \@system \@world		|| EXIT 1
	if ! ${DOFAST}; then
		# note: available on an "as needed" basis
		# note: since gary-os is more about static builds than rolling upgrades, this is unnecessary
#>>>		if [[ -n "$(which perl-cleaner 2>/dev/null)" ]]; then
#>>>			expect_wrapper perl-cleaner --all				|| EXIT 1
#>>>		fi
#>>>		if [[ -n "$(which haskell-updater 2>/dev/null)" ]]; then
#>>>			expect_wrapper haskell-updater --all				|| EXIT 1
#>>>		fi
		expect_wrapper emerge ${_ASK} \@module-rebuild --exclude ${LINPKG}	|| EXIT 1
		expect_wrapper emerge ${_ASK} \@preserved-rebuild			|| EXIT 1
	fi
	expect_wrapper emerge ${_ASK} --depclean					|| EXIT 1
	if ! ${DOFAST}; then
		expect_wrapper revdep-rebuild --ignore					|| EXIT 1
		expect_wrapper emaint --fix all						|| EXIT 1
		expect_wrapper eclean --verbose distfiles				|| EXIT 1
		expect_wrapper eclean --verbose packages				|| EXIT 1
	fi
	safe_env ${_SOUL} ${QUIET_OPT} ${TOOR} ${AUTO} -p				|| EXIT 1
	expect_wrapper dispatch-conf							|| EXIT 1

########################################

#{CMD} declare DISTFILES="/.g/_data/_builds/_gentoo/var/cache/portage/distfiles"
#{CMD} declare DISTFILES="/.g/_data/_builds/.gary-os.release/_distfiles"
#{CMD} (source ./.bashrc; for FILE in ${FILELIST}; do eval \${RSYNC_U} ${DISTFILES}/${FILE} ./build/var/cache/portage/distfiles/; done)

elif [[ ${1} == -U ]]; then
	shift
	declare SYNC="true"
	if [[ ${1} == -f ]]; then
		SYNC="false"
		shift
	fi
	if ${SYNC}; then
		print_info update
		if [[ -z "$(which git 2>/dev/null)" ]]; then
			yes | emaint sync --allrepos				|| EXIT 1
			expect_wrapper emerge ${_ASK} dev-vcs/git		|| EXIT 1
		fi
		if [[ ! -d ${REPDIR}.git ]]; then
			git-clone ${GITDIR} ${REPDIR}				|| EXIT 1
		fi
		if [[ ! -d ${REPDIR} ]]; then
			${MKDIR} ${REPDIR}					|| EXIT 1
		fi
		declare FUN_OPT="-c branch.autosetuprebase=always -c pull.rebase=true"
		declare FUN_GIT="${GIT} --git-dir=${REPDIR}.git --work-tree=${REPDIR} ${FUN_OPT}"
		${FUN_GIT} fetch --all						|| EXIT 1
		${FUN_GIT} checkout --force ${@}				|| EXIT 1
		${FUN_GIT} reset --hard ${@}					|| EXIT 1
		expect_wrapper egencache --verbose				\
			--repo gentoo						\
			--update						\
			--update-manifests					\
			--update-pkg-desc-index					\
			--update-use-local-desc					\
										#>>> || EXIT 1
		if [[ -n "$(which eix-update 2>/dev/null)" ]]; then
			expect_wrapper eix-update				|| EXIT 1
		fi
	fi
	declare FAIL="false"
	FILE="--fetch-all-uri"
	if ${_GOS}; then
		FILE="--fetchonly"
	fi
	expect_wrapper emerge --ask=n --emptytree ${FILE}			\
		\@system \@world						2>&1 | tee ${DSTDIR}.log
	if [[ ${PIPESTATUS[0]} != 0 ]]; then
		FAIL="true"
		echo -en "\n"							1>&2
		echo -en "FILELIST=\""						1>&2
		${SED} -n \
			-e "s/^.*Couldn[']t[ ]download[ ][']([^']+).*$/\1/gp"	\
			-e "s/^.*Fetched[ ]file[:][ ]([^ ]+).*$/\1/gp"		\
			-e "s/^.*Please[ ]download[ ]([^ ]+).*$/\1/gp"		\
			-e "s/^.*and[ ]download[ ]([^ ]+).*$/\1/gp"		\
			${DSTDIR}.log						|
				sort --unique					|
				tr '\n' ' '					|
				${SED} "s|[ ]*$||g"				1>&2
		echo -en "\"\n"							1>&2
	fi
	for FILE in								\
		$(find ${DSTDIR}/*checksum_failure*	2>/dev/null | sort)	\
		$(find ${DSTDIR}/.*.portage_lockfile	2>/dev/null | sort)	\
	; do
		FAIL="true"
		${RM} ${FILE}							1>&2
	done
	delete_empty ${TMPDIR} -a						1>&2
	${RM} ${DSTDIR}.log							1>&2
	if ${FAIL}; then
		EXIT 1
	fi
	if ! ${SYNC}; then
		EXIT 0
	fi

########################################

elif {
	${DO_CHROOT} &&
	[[ ${1} == -! ]];
}; then
	mount_dev_dirs						|| EXIT 1
	#note: ensuring configuration is up-to-date
	if ! ${_SOUL} ${QUIET_OPT} ${TOOR} -r			2>&1 |
		if ${QUIET}; then prompt -t; else cat; fi; then	EXIT 1; fi
	safe_env ${MYSELF} ${QUIET_OPT} ${TOOR} ${AUTO} -!	|| EXIT 1
	mount_dev_dirs -u					|| EXIT 1
	EXIT 0
fi

################################################################################

#>>> if ! ${_GOS}; then
#>>> 	safe_env ${SETDIR}/${FUNDIR}/.hacks
#>>> fi

########################################

echo -en "\n"
${LL} \
	/tmp \
	/var/tmp

echo -en "\n"
${LL} \
	/boot \
	/etc/kernels \
	/lib/modules \
	/usr/src

echo -en "\n"
${LL} \
	/ \
	/_build

########################################

safe_env ${SETDIR}/${FUNDIR}/${AUDITS}

EXIT 0
################################################################################
# end of file
################################################################################
