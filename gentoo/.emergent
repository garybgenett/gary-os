#!/usr/bin/env bash
################################################################################

declare OUT_DIR="/_gentoo"
mkdir -pv ${OUT_DIR}

########################################

declare TOKEN

################################################################################

declare EMERGE_CMD="$(which emerge) --verbose --pretend"
env - ${EMERGE_CMD} --emptytree system world	>${OUT_DIR}/.emerge	2>&1
env - ${EMERGE_CMD} --info			>${OUT_DIR}/.info	2>&1
sort /var/lib/portage/world			>${OUT_DIR}/.world	2>&1

########################################

cat ${OUT_DIR}/.emerge |
	grep -E "^\["			|
	awk '{print $4;}'		|
	sort				\
	>${OUT_DIR}/_packages

cat /dev/null >${OUT_DIR}/_packages.added

for TOKEN in $(cat ${OUT_DIR}/_packages); do
	if [[ -z $(grep -E "^${TOKEN/%-[0-9].*}" /var/lib/portage/world) ]]; then
		echo "${TOKEN}" >>${OUT_DIR}/_packages.added
	fi
done

cat /dev/null >${OUT_DIR}/_packages.use

for TOKEN in $(cat ${OUT_DIR}/_packages); do
	grep -E "^${TOKEN/%-[0-9].*}[:]" /usr/portage/profiles/use.local.desc |
		sort \
		>>${OUT_DIR}/_packages.use
done

########################################

cat /dev/null >${OUT_DIR}/_use.disabled
cat /dev/null >${OUT_DIR}/_use.enabled

for TOKEN in $(source /etc/make.conf ; echo ${USE}); do
	if [[ ${TOKEN} == ${TOKEN/#-} ]]; then
		grep -E "^${TOKEN}[ ][-]" /usr/portage/profiles/use.desc |
			sort \
			>>${OUT_DIR}/_use.enabled
	else
		grep -E "^${TOKEN/#-}[ ][-]" /usr/portage/profiles/use.desc |
			sort \
			>>${OUT_DIR}/_use.disabled
	fi
done

########################################

cat ${OUT_DIR}/.emerge |
	sed -r "s/ ([A-Z_]+=)/\n\1/g"	|
	sed -r "s/\" .*$/\"/g"		|
	grep -E "^[A-Z_]+="		|
	sort				|
	uniq				\
	>${OUT_DIR}/emerge__tmp

grep -E "^USE=" ${OUT_DIR}/emerge__tmp |
	sed -r "s/^USE=\"//g"	|
	sed -r "s/\"$//g"	|
	sed -r "s/[()*%]//g"	|
	sed -r "s/^-//g"	|
	sed -r "s/ -/ /g"	|
	sed -r "s/ /\n/g"	|
	sort			|
	uniq			\
	>${OUT_DIR}/emerge.use

grep -vE "^USE=" ${OUT_DIR}/emerge__tmp |
	sed -r "s/=.+$//g"	|
	sort			|
	uniq			\
	>${OUT_DIR}/emerge.vars

rm -frv ${OUT_DIR}/emerge__tmp

########################################

(source /etc/make.conf ; echo ${USE}) |
	sed -r "s/^-//g"	|
	sed -r "s/ -/ /g"	|
	sed -r "s/ /\n/g"	|
	sort			|
	uniq			\
	>${OUT_DIR}/makeconf.use

grep -E "^[A-Z_]+=" /etc/make.conf |
	grep -vE "^USE="	|
	sed -r "s/=.+$//g"	|
	sort			|
	uniq			\
	>${OUT_DIR}/makeconf.vars

########################################

cat /dev/null >${OUT_DIR}/use.missing.global
cat /dev/null >${OUT_DIR}/use.missing.local

for TOKEN in $(cat ${OUT_DIR}/emerge.use); do
	if [[ -z $(grep -E "^${TOKEN}$" ${OUT_DIR}/makeconf.use) ]]; then
		if [[ -n $(grep -E "^${TOKEN}[ ][-]" /usr/portage/profiles/use.desc) ]]; then
			grep -E "^${TOKEN}[ ][-]" /usr/portage/profiles/use.desc |
				sort \
				>>${OUT_DIR}/use.missing.global
		else
			echo -e "\n${TOKEN}" \
				>>${OUT_DIR}/use.missing.local
			grep -E "[:]${TOKEN}[ ][-]" /usr/portage/profiles/use.local.desc |
				sort \
				>>${OUT_DIR}/use.missing.local
		fi
	fi
done

cat /dev/null >${OUT_DIR}/vars.missing

for TOKEN in $(cat ${OUT_DIR}/emerge.vars); do
	if [[ -z $(grep -E "^${TOKEN}$" ${OUT_DIR}/makeconf.vars) ]]; then
		echo "${TOKEN}" >>${OUT_DIR}/vars.missing
	fi
done

########################################

cat /dev/null >${OUT_DIR}/use.extra

for TOKEN in $(cat ${OUT_DIR}/makeconf.use); do
	if [[ -z $(grep -E "^${TOKEN}$" ${OUT_DIR}/emerge.use) ]]; then
		echo "${TOKEN}" >>${OUT_DIR}/use.extra
	fi
done

cat /dev/null >${OUT_DIR}/vars.extra

for TOKEN in $(cat ${OUT_DIR}/makeconf.vars); do
	if [[ -z $(grep -E "^${TOKEN}$" ${OUT_DIR}/emerge.vars) ]]; then
		echo "${TOKEN}" >>${OUT_DIR}/vars.extra
	fi
done

########################################

cat /dev/null >${OUT_DIR}/+okay

for TOKEN in ${OUT_DIR}/*.OKAY; do
	echo -e "\n${TOKEN/%\.OKAY}" >>${OUT_DIR}/+okay
	diff ${TOKEN} ${TOKEN/%\.OKAY} >>${OUT_DIR}/+okay
done

exit 0
################################################################################
# end of file
################################################################################
